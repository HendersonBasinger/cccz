/**
 * ç®¡ç†å‘˜é¢æ¿è§†å›¾
 */

const db = require('../database');

// åŒ—äº¬æ—¶é—´æ ¼å¼åŒ–
function formatBeijingDateTime(date) {
    if (!date) return '-';
    const d = new Date(date);
    const beijingTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
    const year = beijingTime.getUTCFullYear();
    const month = String(beijingTime.getUTCMonth() + 1).padStart(2, '0');
    const day = String(beijingTime.getUTCDate()).padStart(2, '0');
    const hour = String(beijingTime.getUTCHours()).padStart(2, '0');
    const minute = String(beijingTime.getUTCMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hour}:${minute}`;
}

function formatBeijingDate(date) {
    if (!date) return '-';
    const d = new Date(date);
    const beijingTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
    const year = beijingTime.getUTCFullYear();
    const month = String(beijingTime.getUTCMonth() + 1).padStart(2, '0');
    const day = String(beijingTime.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// æ¸²æŸ“ç®¡ç†å‘˜ç™»å½•é¡µé¢
function renderAdminLoginPage(adminPath) {
    return `
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
      <title>ç®¡ç†å‘˜ç™»å½•</title>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-box h2 { text-align: center; margin-bottom: 30px; color: #333; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #666; font-size: 14px; }
        input[type=text], input[type=password] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #667eea; }
        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .error { color: #ff4d4f; font-size: 14px; margin-top: 10px; text-align: center; display: none; }
      </style>
    </head>
    <body>
      <div class="login-box">
        <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
        <form id="loginForm">
          <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="username" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
          </div>
          <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
          </div>
          <button type="submit">ç™» å½•</button>
          <div class="error" id="errorMsg"></div>
        </form>
      </div>
      <script>
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const errorMsg = document.getElementById('errorMsg');
          errorMsg.style.display = 'none';
          
          try {
            const formData = new FormData(this);
            const response = await fetch('/api/admin/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: formData.get('username'),
                password: formData.get('password')
              })
            });
            
            const result = await response.json();
            
            if (result.success) {
              window.location.href = '${adminPath}';
            } else {
              errorMsg.textContent = result.error || 'ç™»å½•å¤±è´¥';
              errorMsg.style.display = 'block';
            }
          } catch (e) {
            errorMsg.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            errorMsg.style.display = 'block';
          }
        });
      </script>
    </body>
    </html>
    `;
}

// æ¸²æŸ“ç®¡ç†å‘˜é¢æ¿
async function renderAdminPanel(adminPath) {
    const usersData = db.getAllUsers();
    const rawSettings = db.getSettings();
    const settings = rawSettings || { proxyIPs: [], bestDomains: [], subUrl: "" };
    
    let proxyIPsList = settings.proxyIPs || [];
    let bestDomainsList = settings.bestDomains || [];
    let subUrl = settings.subUrl || "";
    let websiteUrl = settings.websiteUrl || "";
    let siteName = settings.siteName || "CFly";

    const rows = usersData.map(u => {
        const isExpired = u.expiry && u.expiry < Date.now();
        const isEnabled = u.enabled;
        
        const expiryText = u.expiry ? formatBeijingDateTime(u.expiry) : 'æœªæ¿€æ´»';
        const expiryVal = u.expiry ? formatBeijingDate(u.expiry) : '';
        const createDate = u.createAt ? formatBeijingDateTime(u.createAt) : '-';
        
        let statusHtml = !u.expiry ? '<span class="tag disabled">æœªæ¿€æ´»</span>' : 
            (isExpired ? '<span class="tag expired">å·²è¿‡æœŸ</span>' : 
            (!isEnabled ? '<span class="tag disabled">å·²ç¦ç”¨</span>' : '<span class="tag active">æ­£å¸¸</span>'));
        
        const safeName = (u.name || '').replace(/'/g, "\\'");
        
        return `<tr data-uuid="${u.uuid}">
            <td><input type="checkbox" class="u-check" value="${u.uuid}"></td>
            <td class="mono" onclick="copy('${u.uuid}')">${u.uuid}</td>
            <td>${u.name}</td>
            <td>${createDate}</td>
            <td>${expiryText}</td>
            <td>${statusHtml}</td>
            <td class="actions">
                <button class="btn-action btn-copy" onclick="copySubOriginal('${u.uuid}')">è®¢é˜…</button>
                <button class="btn-action btn-edit" onclick="openEdit('${u.uuid}', '${safeName}', '${expiryVal}')">ç¼–è¾‘</button>
                ${isEnabled && !isExpired ? `<button class="btn-action btn-danger" onclick="toggleStatus('${u.uuid}', false)">ç¦ç”¨</button>` : ''}
                ${!isEnabled && !isExpired ? `<button class="btn-action btn-success" onclick="toggleStatus('${u.uuid}', true)">å¯ç”¨</button>` : ''}
                <button class="btn-action btn-del" onclick="delUser('${u.uuid}')">åˆ é™¤</button>
            </td>
        </tr>`;
    }).join('');

    return `
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <title>${siteName} æ§åˆ¶é¢æ¿</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            :root { --primary: #1890ff; --bg: #f0f2f5; --danger: #ff4d4f; --success: #52c41a; --warning: #faad14; --purple: #722ed1; --grey: #bfbfbf; }
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #333; }
            
            .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
            .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            .header h1 { font-size: 24px; color: #333; }
            .header-actions { display: flex; gap: 10px; }
            
            .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            .card h3 { margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            
            .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
            .stat-box { padding: 20px; border-radius: 8px; text-align: center; }
            .stat-box .number { font-size: 32px; font-weight: bold; }
            .stat-box .label { margin-top: 8px; color: #666; }
            
            label { display: block; margin-bottom: 8px; font-size: 14px; color: #666; font-weight: 600; }
            input[type=text], input[type=date], input[type=password], textarea { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px; font-family: inherit; }
            input:focus, textarea:focus { border-color: var(--primary); outline: none; }
            textarea { resize: vertical; min-height: 80px; font-family: monospace; }
            
            button { padding: 8px 16px; color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; }
            button:hover { opacity: 0.9; }
            .btn-primary { background: var(--primary); }
            .btn-danger { background: var(--danger); }
            .btn-success { background: var(--success); }
            .btn-warning { background: var(--warning); }
            
            table { width: 100%; border-collapse: collapse; font-size: 14px; }
            th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #f0f0f0; }
            th { background: #fafafa; color: #666; font-weight: 600; }
            tr:hover { background: #fdfdfd; }
            .mono { font-family: monospace; color: var(--primary); cursor: pointer; }
            
            .tag { font-size: 12px; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
            .tag.active { color: var(--success); background: #f6ffed; border: 1px solid #b7eb8f; }
            .tag.expired { color: var(--danger); background: #fff1f0; border: 1px solid #ffa39e; }
            .tag.disabled { color: #999; background: #f5f5f5; border: 1px solid #d9d9d9; }
            
            .actions { white-space: nowrap; }
            .btn-action { padding: 4px 10px; font-size: 12px; margin-right: 4px; }
            .btn-copy { background: var(--purple); }
            .btn-edit { background: var(--warning); }
            .btn-del { background: #ff7875; }
            
            .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
            .tab { padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; }
            .tab.active { background: var(--primary); color: white; }
            
            .section { display: none; }
            .section.active { display: block; }
            
            .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100; }
            .modal { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; }
            .modal h3 { margin-bottom: 20px; }
            
            #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 4px; opacity: 0; transition: 0.3s; z-index: 200; }
            #toast.show { opacity: 1; bottom: 50px; }
            
            .config-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #f9f9f9; border-radius: 4px; margin-bottom: 5px; font-family: monospace; font-size: 13px; }
            .config-item .del-btn { color: var(--danger); cursor: pointer; font-weight: bold; }
            
            @media (max-width: 768px) {
                .header { flex-direction: column; gap: 15px; }
                .grid { grid-template-columns: 1fr; }
                table { font-size: 12px; }
                th, td { padding: 8px 5px; }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸš€ ${siteName} æ§åˆ¶é¢æ¿</h1>
                <div class="header-actions">
                    <span style="color:#666;">${formatBeijingDate(Date.now())}</span>
                    <button onclick="adminLogout()" class="btn-danger">é€€å‡ºç™»å½•</button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-section="dashboard" onclick="switchTab('dashboard')">ğŸ“Š ä»ªè¡¨ç›˜</button>
                <button class="tab" data-section="users" onclick="switchTab('users')">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</button>
                <button class="tab" data-section="config" onclick="switchTab('config')">âš™ï¸ é…ç½®ç®¡ç†</button>
            </div>
            
            <!-- ä»ªè¡¨ç›˜ -->
            <div id="section-dashboard" class="section active">
                <div class="card">
                    <h3>ç³»ç»Ÿæ¦‚è§ˆ</h3>
                    <div class="grid">
                        <div class="stat-box" style="background:#e6f7ff;">
                            <div class="number" style="color:var(--primary);">${usersData.length}</div>
                            <div class="label">æ€»ç”¨æˆ·æ•°</div>
                        </div>
                        <div class="stat-box" style="background:#f6ffed;">
                            <div class="number" style="color:var(--success);">${usersData.filter(u => u.enabled && (!u.expiry || u.expiry > Date.now())).length}</div>
                            <div class="label">æ´»è·ƒç”¨æˆ·</div>
                        </div>
                        <div class="stat-box" style="background:#fff7e6;">
                            <div class="number" style="color:var(--warning);">${bestDomainsList.length}</div>
                            <div class="label">é…ç½®èŠ‚ç‚¹æ•°</div>
                        </div>
                        <div class="stat-box" style="background:#fff1f0;">
                            <div class="number" style="color:var(--danger);">${usersData.filter(u => u.expiry && u.expiry < Date.now()).length}</div>
                            <div class="label">å·²è¿‡æœŸç”¨æˆ·</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ç³»ç»Ÿè®¾ç½®</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;">
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                            <input type="checkbox" id="enableRegisterCheck" ${settings.enableRegister ? 'checked' : ''} onchange="updateSystemSettings()">
                            <span>å¼€æ”¾ç”¨æˆ·æ³¨å†Œ</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                            <input type="checkbox" id="autoApproveOrderCheck" ${settings.autoApproveOrder ? 'checked' : ''} onchange="updateSystemSettings()">
                            <span>è‡ªåŠ¨å®¡æ ¸å…è´¹è®¢å•</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                            <input type="checkbox" id="enableTrialCheck" ${settings.enableTrial ? 'checked' : ''} onchange="updateSystemSettings()">
                            <span>æ–°ç”¨æˆ·è¯•ç”¨</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                            <input type="checkbox" id="requireInviteCodeCheck" ${settings.requireInviteCode ? 'checked' : ''} onchange="updateSystemSettings()">
                            <span>æ³¨å†Œéœ€é‚€è¯·ç </span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- ç”¨æˆ·ç®¡ç† -->
            <div id="section-users" class="section">
                <div class="card">
                    <h3>æ·»åŠ ç”¨æˆ·</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;">
                        <div><label>ç”¨æˆ·åç§°</label><input type="text" id="addName" placeholder="ç”¨æˆ·å¤‡æ³¨å"></div>
                        <div><label>åˆ°æœŸæ—¥æœŸ</label><input type="date" id="addExpiry"></div>
                        <div><label>å‰ç«¯ç”¨æˆ·å</label><input type="text" id="addFrontUsername" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ"></div>
                        <div><label>å‰ç«¯å¯†ç </label><input type="text" id="addFrontPassword" placeholder="ç•™ç©ºä¸ç”¨æˆ·åç›¸åŒ"></div>
                    </div>
                    <div style="margin-top:15px;"><label>è‡ªå®šä¹‰ UUID (å¯é€‰)</label><textarea id="addUUIDs" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼Œå¤šä¸ªUUIDç”¨æ¢è¡Œåˆ†éš”"></textarea></div>
                    <div style="margin-top:15px;"><button onclick="addUser()" class="btn-primary">æ·»åŠ ç”¨æˆ·</button></div>
                </div>
                
                <div class="card">
                    <h3>ç”¨æˆ·åˆ—è¡¨ (${usersData.length})</h3>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="checkAll" onchange="toggleCheckAll()"></th>
                                    <th>UUID</th>
                                    <th>åç§°</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>åˆ°æœŸæ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userTable">${rows}</tbody>
                        </table>
                    </div>
                    <div style="margin-top:15px;display:flex;gap:10px;">
                        <button onclick="batchEnable()" class="btn-success">æ‰¹é‡å¯ç”¨</button>
                        <button onclick="batchDisable()" class="btn-warning">æ‰¹é‡ç¦ç”¨</button>
                        <button onclick="batchDelete()" class="btn-danger">æ‰¹é‡åˆ é™¤</button>
                    </div>
                </div>
            </div>
            
            <!-- é…ç½®ç®¡ç† -->
            <div id="section-config" class="section">
                <div class="card">
                    <h3>è®¢é˜…é…ç½®</h3>
                    <div style="margin-bottom:15px;">
                        <label>èŠ‚ç‚¹è®¢é˜…åœ°å€</label>
                        <input type="text" id="subUrl" value="${subUrl}" placeholder="ç”¨äºç”Ÿæˆè®¢é˜…é“¾æ¥çš„åœ°å€">
                    </div>
                    <div style="margin-bottom:15px;">
                        <label>å®˜ç½‘åœ°å€</label>
                        <input type="text" id="websiteUrl" value="${websiteUrl}" placeholder="æ˜¾ç¤ºåœ¨è®¢é˜…ä¸­çš„å®˜ç½‘åœ°å€">
                    </div>
                </div>
                
                <div class="card">
                    <h3>åä»£ IP åˆ—è¡¨</h3>
                    <div style="margin-bottom:10px;">
                        <textarea id="proxyIPInput" placeholder="ä¸€è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚ï¼šProxyIP.HK.CMLiussss.net:443">${proxyIPsList.join('\n')}</textarea>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ä¼˜é€‰åŸŸååˆ—è¡¨</h3>
                    <div style="margin-bottom:10px;">
                        <textarea id="bestDomainsInput" placeholder="ä¸€è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šåŸŸå:ç«¯å£#åˆ«å" style="min-height:150px;">${bestDomainsList.join('\n')}</textarea>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button onclick="fetchBestIPs('v4')" class="btn-primary">è·å– IPv4 ä¼˜é€‰</button>
                        <button onclick="fetchBestIPs('v6')" class="btn-primary">è·å– IPv6 ä¼˜é€‰</button>
                    </div>
                </div>
                
                <div style="margin-top:20px;">
                    <button onclick="saveSettings()" class="btn-primary" style="width:100%;padding:15px;font-size:16px;">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</button>
                </div>
            </div>
        </div>
        
        <!-- ç¼–è¾‘å¼¹çª— -->
        <div class="modal-overlay" id="editModal">
            <div class="modal">
                <h3>ç¼–è¾‘ç”¨æˆ·</h3>
                <input type="hidden" id="editUUID">
                <div style="margin-bottom:15px;"><label>åç§°</label><input type="text" id="editName"></div>
                <div style="margin-bottom:15px;"><label>åˆ°æœŸæ—¥æœŸ</label><input type="date" id="editExpiry"></div>
                <div style="margin-bottom:15px;"><label>æ–°å¯†ç  (ç•™ç©ºä¸ä¿®æ”¹)</label><input type="password" id="editPassword"></div>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveEdit()" class="btn-primary">ä¿å­˜</button>
                    <button onclick="closeEdit()" style="background:#999;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
        <div id="toast"></div>
        
        <script>
            function toast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
            
            function copy(text) {
                navigator.clipboard.writeText(text).then(() => toast('å·²å¤åˆ¶: ' + text.substring(0, 20) + '...'));
            }
            
            function copySubOriginal(uuid) {
                const subUrl = document.getElementById('subUrl').value || window.location.origin;
                const url = subUrl.includes('://') ? subUrl + '/' + uuid : 'https://' + subUrl + '/' + uuid;
                copy(url);
            }
            
            function switchTab(section) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelector('[data-section="' + section + '"]').classList.add('active');
                document.getElementById('section-' + section).classList.add('active');
            }
            
            function toggleCheckAll() {
                const checked = document.getElementById('checkAll').checked;
                document.querySelectorAll('.u-check').forEach(c => c.checked = checked);
            }
            
            function getSelectedUUIDs() {
                return Array.from(document.querySelectorAll('.u-check:checked')).map(c => c.value);
            }
            
            async function addUser() {
                const formData = new FormData();
                formData.append('name', document.getElementById('addName').value);
                formData.append('expiryDate', document.getElementById('addExpiry').value);
                formData.append('uuids', document.getElementById('addUUIDs').value);
                formData.append('frontUsername', document.getElementById('addFrontUsername').value);
                formData.append('frontPassword', document.getElementById('addFrontPassword').value);
                
                const res = await fetch('/api/admin/add', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Object.fromEntries(formData))
                });
                if (res.ok) { toast('æ·»åŠ æˆåŠŸ'); location.reload(); }
                else toast('æ·»åŠ å¤±è´¥');
            }
            
            function openEdit(uuid, name, expiry) {
                document.getElementById('editUUID').value = uuid;
                document.getElementById('editName').value = name;
                document.getElementById('editExpiry').value = expiry;
                document.getElementById('editPassword').value = '';
                document.getElementById('editModal').style.display = 'flex';
            }
            
            function closeEdit() {
                document.getElementById('editModal').style.display = 'none';
            }
            
            async function saveEdit() {
                const data = {
                    uuid: document.getElementById('editUUID').value,
                    name: document.getElementById('editName').value,
                    expiryDate: document.getElementById('editExpiry').value,
                    newPassword: document.getElementById('editPassword').value
                };
                
                const res = await fetch('/api/admin/update', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) { toast('ä¿å­˜æˆåŠŸ'); location.reload(); }
                else toast('ä¿å­˜å¤±è´¥');
            }
            
            async function toggleStatus(uuid, enabled) {
                const res = await fetch('/api/admin/status', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uuids: uuid, enabled: enabled.toString() })
                });
                if (res.ok) location.reload();
            }
            
            async function delUser(uuid) {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·ï¼Ÿ')) return;
                const res = await fetch('/api/admin/delete', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uuids: uuid })
                });
                if (res.ok) location.reload();
            }
            
            async function batchEnable() {
                const uuids = getSelectedUUIDs();
                if (uuids.length === 0) return toast('è¯·é€‰æ‹©ç”¨æˆ·');
                await fetch('/api/admin/status', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uuids: uuids.join(','), enabled: 'true' })
                });
                location.reload();
            }
            
            async function batchDisable() {
                const uuids = getSelectedUUIDs();
                if (uuids.length === 0) return toast('è¯·é€‰æ‹©ç”¨æˆ·');
                await fetch('/api/admin/status', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uuids: uuids.join(','), enabled: 'false' })
                });
                location.reload();
            }
            
            async function batchDelete() {
                const uuids = getSelectedUUIDs();
                if (uuids.length === 0) return toast('è¯·é€‰æ‹©ç”¨æˆ·');
                if (!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ' + uuids.length + ' ä¸ªç”¨æˆ·ï¼Ÿ')) return;
                await fetch('/api/admin/delete', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uuids: uuids.join(',') })
                });
                location.reload();
            }
            
            async function saveSettings() {
                const data = {
                    subUrl: document.getElementById('subUrl').value,
                    websiteUrl: document.getElementById('websiteUrl').value,
                    proxyIP: document.getElementById('proxyIPInput').value,
                    bestDomains: document.getElementById('bestDomainsInput').value
                };
                
                const res = await fetch('/api/admin/saveSettings', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) toast('é…ç½®å·²ä¿å­˜');
                else toast('ä¿å­˜å¤±è´¥');
            }
            
            async function updateSystemSettings() {
                const data = {
                    enableRegister: document.getElementById('enableRegisterCheck').checked.toString(),
                    autoApproveOrder: document.getElementById('autoApproveOrderCheck').checked.toString(),
                    enableTrial: document.getElementById('enableTrialCheck').checked.toString(),
                    requireInviteCode: document.getElementById('requireInviteCodeCheck').checked.toString()
                };
                
                await fetch('/api/admin/updateSystemSettings', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                toast('è®¾ç½®å·²æ›´æ–°');
            }
            
            async function fetchBestIPs(type) {
                toast('æ­£åœ¨è·å– ' + type.toUpperCase() + ' ä¼˜é€‰IP...');
                const res = await fetch('/api/admin/fetchBestIPs', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type })
                });
                const result = await res.json();
                
                if (result.success) {
                    const textarea = document.getElementById('bestDomainsInput');
                    const newIPs = result.data.map(d => d.entry).join('\\n');
                    textarea.value = textarea.value ? textarea.value + '\\n' + newIPs : newIPs;
                    toast('è·å–æˆåŠŸ: ' + result.count + ' æ¡');
                } else {
                    toast('è·å–å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            }
            
            async function adminLogout() {
                await fetch('/api/admin/logout', { method: 'POST' });
                location.reload();
            }
        </script>
    </body>
    </html>
    `;
}

module.exports = {
    renderAdminPanel,
    renderAdminLoginPage
};
