/**
 * ç”¨æˆ·å‰ç«¯è§†å›¾
 */

const db = require('../database');

// åŒ—äº¬æ—¶é—´æ ¼å¼åŒ–
function formatBeijingDateTime(date) {
    if (!date) return '-';
    const d = new Date(date);
    const beijingTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
    const year = beijingTime.getUTCFullYear();
    const month = String(beijingTime.getUTCMonth() + 1).padStart(2, '0');
    const day = String(beijingTime.getUTCDate()).padStart(2, '0');
    const hour = String(beijingTime.getUTCHours()).padStart(2, '0');
    const minute = String(beijingTime.getUTCMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hour}:${minute}`;
}

function formatBeijingDate(date) {
    if (!date) return '-';
    const d = new Date(date);
    const beijingTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
    const year = beijingTime.getUTCFullYear();
    const month = String(beijingTime.getUTCMonth() + 1).padStart(2, '0');
    const day = String(beijingTime.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// æ¸²æŸ“ç™»å½•/æ³¨å†Œé¡µé¢
async function renderAuthPage() {
    const settings = db.getSettings() || {};
    const siteName = settings.siteName || 'CFly';
    const enableRegister = settings.enableRegister === true;
    const requireInviteCode = settings.requireInviteCode === true;
    
    return `
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <title>${siteName} - ç”¨æˆ·ç™»å½•</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
            .auth-box { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 400px; overflow: hidden; }
            .auth-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; color: white; }
            .auth-header h1 { font-size: 28px; margin-bottom: 5px; }
            .auth-header p { opacity: 0.9; }
            .auth-tabs { display: flex; border-bottom: 1px solid #eee; }
            .auth-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; background: #f9f9f9; border: none; font-size: 16px; transition: 0.3s; }
            .auth-tab.active { background: white; color: #667eea; font-weight: 600; }
            .auth-form { padding: 30px; display: none; }
            .auth-form.active { display: block; }
            .form-group { margin-bottom: 20px; }
            label { display: block; margin-bottom: 8px; color: #666; font-size: 14px; }
            input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
            input:focus { outline: none; border-color: #667eea; }
            button[type=submit] { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.2s; }
            button[type=submit]:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
            .error { color: #ff4d4f; font-size: 14px; margin-top: 10px; text-align: center; display: none; }
            .success { color: #52c41a; font-size: 14px; margin-top: 10px; text-align: center; display: none; }
            .register-disabled { text-align: center; padding: 20px; color: #999; }
        </style>
    </head>
    <body>
        <div class="auth-box">
            <div class="auth-header">
                <h1>ğŸš€ ${siteName}</h1>
                <p>æ¬¢è¿ä½¿ç”¨</p>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">ç™»å½•</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
            </div>
            
            <!-- ç™»å½•è¡¨å• -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit">ç™» å½•</button>
                <div class="error" id="loginError"></div>
            </form>
            
            <!-- æ³¨å†Œè¡¨å• -->
            <form id="registerForm" class="auth-form">
                ${enableRegister ? `
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" name="username" placeholder="3-20ä¸ªå­—ç¬¦" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" name="password" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦" required>
                </div>
                <div class="form-group">
                    <label>é‚®ç®± (å¯é€‰)</label>
                    <input type="email" name="email" placeholder="ç”¨äºæ‰¾å›å¯†ç ">
                </div>
                ${requireInviteCode ? `
                <div class="form-group">
                    <label>é‚€è¯·ç </label>
                    <input type="text" name="invite_code" placeholder="è¯·è¾“å…¥é‚€è¯·ç " required>
                </div>
                ` : ''}
                <button type="submit">æ³¨ å†Œ</button>
                <div class="error" id="registerError"></div>
                <div class="success" id="registerSuccess"></div>
                ` : `
                <div class="register-disabled">
                    <p>ğŸ”’ æš‚æœªå¼€æ”¾æ³¨å†Œ</p>
                    <p style="font-size:12px;margin-top:10px;">è¯·è”ç³»ç®¡ç†å‘˜è·å–è´¦å·</p>
                </div>
                `}
            </form>
        </div>
        
        <script>
            function switchAuthTab(tab) {
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(tab + 'Form').classList.add('active');
            }
            
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const errorEl = document.getElementById('loginError');
                errorEl.style.display = 'none';
                
                try {
                    const formData = new FormData(this);
                    const response = await fetch('/api/user/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: formData.get('username'),
                            password: formData.get('password')
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.reload();
                    } else {
                        errorEl.textContent = result.error || 'ç™»å½•å¤±è´¥';
                        errorEl.style.display = 'block';
                    }
                } catch (e) {
                    errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                    errorEl.style.display = 'block';
                }
            });
            
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const errorEl = document.getElementById('registerError');
                const successEl = document.getElementById('registerSuccess');
                errorEl.style.display = 'none';
                successEl.style.display = 'none';
                
                try {
                    const formData = new FormData(this);
                    const response = await fetch('/api/user/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: formData.get('username'),
                            password: formData.get('password'),
                            email: formData.get('email'),
                            invite_code: formData.get('invite_code')
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successEl.textContent = result.message || 'æ³¨å†ŒæˆåŠŸï¼';
                        successEl.style.display = 'block';
                        setTimeout(() => switchAuthTab('login'), 1500);
                    } else {
                        errorEl.textContent = result.error || 'æ³¨å†Œå¤±è´¥';
                        errorEl.style.display = 'block';
                    }
                } catch (e) {
                    errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                    errorEl.style.display = 'block';
                }
            });
        </script>
    </body>
    </html>
    `;
}

// æ¸²æŸ“ç”¨æˆ·ä»ªè¡¨æ¿
async function renderUserPanel(userInfo) {
    const settings = db.getSettings() || {};
    const siteName = settings.siteName || 'CFly';
    const subUrl = settings.subUrl || '';
    
    const isExpired = userInfo.expiry && userInfo.expiry < Date.now();
    const statusText = isExpired ? 'å·²è¿‡æœŸ' : (!userInfo.enabled ? 'å·²ç¦ç”¨' : 'æ­£å¸¸');
    const statusColor = isExpired ? '#ff4d4f' : (!userInfo.enabled ? '#999' : '#52c41a');
    
    return `
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <title>${siteName} - ç”¨æˆ·ä¸­å¿ƒ</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }
            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; color: white; }
            .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
            .header h1 { font-size: 24px; }
            .header-actions button { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; }
            .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
            .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            .card h3 { margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
            .info-item { padding: 15px; background: #f9f9f9; border-radius: 6px; }
            .info-item .label { color: #666; font-size: 14px; margin-bottom: 5px; }
            .info-item .value { font-size: 18px; font-weight: 600; color: #333; word-break: break-all; }
            .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 500; }
            .sub-box { background: #f0f5ff; border: 1px solid #91d5ff; border-radius: 6px; padding: 15px; margin-top: 15px; }
            .sub-url { font-family: monospace; font-size: 14px; word-break: break-all; background: white; padding: 10px; border-radius: 4px; margin-top: 10px; }
            .copy-btn { padding: 8px 20px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
            .copy-btn:hover { background: #40a9ff; }
            #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 4px; opacity: 0; transition: 0.3s; z-index: 200; }
            #toast.show { opacity: 1; bottom: 50px; }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="header-content">
                <h1>ğŸš€ ${siteName}</h1>
                <div class="header-actions">
                    <span style="margin-right:15px;">ğŸ‘‹ ${userInfo.username}</span>
                    <button onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
        
        <div class="container">
            <div class="card">
                <h3>è´¦æˆ·ä¿¡æ¯</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="label">ç”¨æˆ·å</div>
                        <div class="value">${userInfo.username}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">çŠ¶æ€</div>
                        <div class="value"><span class="status-badge" style="background:${statusColor}20;color:${statusColor};">${statusText}</span></div>
                    </div>
                    <div class="info-item">
                        <div class="label">åˆ°æœŸæ—¶é—´</div>
                        <div class="value">${userInfo.expiry ? formatBeijingDateTime(userInfo.expiry) : 'æœªæ¿€æ´»'}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">æ³¨å†Œæ—¶é—´</div>
                        <div class="value">${formatBeijingDateTime(userInfo.createdAt)}</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>æˆ‘çš„è®¢é˜…</h3>
                <div class="info-item" style="background:#fff;">
                    <div class="label">UUID</div>
                    <div class="value" style="cursor:pointer;" onclick="copy('${userInfo.uuid}')">${userInfo.uuid}</div>
                </div>
                <div class="sub-box">
                    <div style="font-weight:600;color:#0050b3;">ğŸ“‹ è®¢é˜…åœ°å€</div>
                    <div class="sub-url" id="subUrl">${subUrl ? (subUrl.includes('://') ? subUrl : 'https://' + subUrl) + '/' + userInfo.uuid : 'æœªé…ç½®è®¢é˜…åœ°å€'}</div>
                    <button class="copy-btn" onclick="copy(document.getElementById('subUrl').textContent)">ğŸ“‹ å¤åˆ¶è®¢é˜…</button>
                </div>
            </div>
            
            <div class="card">
                <h3>ä½¿ç”¨è¯´æ˜</h3>
                <div style="line-height:1.8;color:#666;">
                    <p>1. å¤åˆ¶ä¸Šæ–¹çš„è®¢é˜…åœ°å€</p>
                    <p>2. æ‰“å¼€ä½ çš„ä»£ç†å®¢æˆ·ç«¯ (Clash/V2Ray/Shadowrocket ç­‰)</p>
                    <p>3. æ·»åŠ è®¢é˜…é“¾æ¥ï¼Œç²˜è´´å¹¶æ›´æ–°</p>
                    <p>4. é€‰æ‹©èŠ‚ç‚¹ï¼Œå¼€å§‹ä½¿ç”¨</p>
                </div>
            </div>
        </div>
        
        <div id="toast"></div>
        
        <script>
            function toast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
            
            function copy(text) {
                navigator.clipboard.writeText(text).then(() => toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
            }
            
            async function logout() {
                await fetch('/api/user/logout', { method: 'POST' });
                window.location.reload();
            }
        </script>
    </body>
    </html>
    `;
}

module.exports = {
    renderAuthPage,
    renderUserPanel
};
