/**
 * ç®¡ç†å‘˜é¢æ¿è§†å›¾ - å®Œæ•´ç‰ˆï¼ˆå«å¥—é¤å’Œè®¢å•ç®¡ç†ï¼‰
 */

const db = require('../database');

// æ—¶é—´æ ¼å¼åŒ–
function formatBeijingDateTime(date) {
    if (!date) return '-';
    const d = new Date(date);
    const beijingTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
    const year = beijingTime.getUTCFullYear();
    const month = String(beijingTime.getUTCMonth() + 1).padStart(2, '0');
    const day = String(beijingTime.getUTCDate()).padStart(2, '0');
    const hour = String(beijingTime.getUTCHours()).padStart(2, '0');
    const minute = String(beijingTime.getUTCMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hour}:${minute}`;
}

function formatBeijingDate(date) {
    if (!date) return '-';
    const d = new Date(date);
    const beijingTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
    const year = beijingTime.getUTCFullYear();
    const month = String(beijingTime.getUTCMonth() + 1).padStart(2, '0');
    const day = String(beijingTime.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function renderAdminLoginPage(adminPath) {
    return `<!DOCTYPE html><html><head><title>ç®¡ç†å‘˜ç™»å½•</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center}.login-box{background:white;padding:40px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.2);width:100%;max-width:400px}.login-box h2{text-align:center;margin-bottom:30px;color:#333}.form-group{margin-bottom:20px}label{display:block;margin-bottom:8px;color:#666;font-size:14px}input[type=text],input[type=password]{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px}input:focus{outline:none;border-color:#667eea}button{width:100%;padding:14px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:6px;font-size:16px;cursor:pointer}button:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,0.4)}.error{color:#ff4d4f;font-size:14px;margin-top:10px;text-align:center;display:none}.switch{position:relative;display:inline-block;width:44px;height:22px;cursor:pointer}.switch .slider{position:absolute;top:0;left:0;right:0;bottom:0;background:#d9d9d9;border-radius:22px;transition:0.4s}.switch .slider:before{content:'';position:absolute;height:18px;width:18px;left:2px;bottom:2px;background:white;border-radius:50%;transition:0.4s}.switch input:checked+.slider{background:#52c41a}.switch input:checked+.slider:before{transform:translateX(22px)}</style></head><body><div class="login-box"><h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2><form id="loginForm"><div class="form-group"><label>ç”¨æˆ·å</label><input type="text" id="username" name="username" required></div><div class="form-group"><label>å¯†ç </label><input type="password" id="password" name="password" required></div><button type="submit">ç™» å½•</button><div class="error" id="errorMsg"></div></form></div><script>
document.getElementById('loginForm').addEventListener('submit',async function(e){e.preventDefault();const errorMsg=document.getElementById('errorMsg');errorMsg.style.display='none';try{const username=document.getElementById('username').value;const password=document.getElementById('password').value;const response=await fetch('/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:username,password:password})});const result=await response.json();if(result.success){window.location.href='${adminPath}';}else{errorMsg.textContent=result.error||'ç™»å½•å¤±è´¥';errorMsg.style.display='block';}}catch(e){errorMsg.textContent='ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';errorMsg.style.display='block';}});</script></body></html>`;
}

async function renderAdminPanel(adminPath) {
    const usersData = db.getAllUsers();
    const settings = db.getSettings() || {};
    const siteName = settings.siteName || "CFly";
    
    // ç”Ÿæˆç”¨æˆ·åˆ—è¡¨
    const userRows = usersData.map(u => {
        const isExpired = u.expiry && u.expiry < Date.now();
        const isEnabled = u.enabled;
        const expiryText = u.expiry ? formatBeijingDateTime(u.expiry) : 'æœªæ¿€æ´»';
        const expiryVal = u.expiry ? formatBeijingDate(u.expiry) : '';
        const createDate = u.createAt ? formatBeijingDateTime(u.createAt) : '-';
        let statusHtml = !u.expiry ? '<span class="tag disabled">æœªæ¿€æ´»</span>' : 
            (isExpired ? '<span class="tag expired">å·²è¿‡æœŸ</span>' : 
            (!isEnabled ? '<span class="tag disabled">å·²ç¦ç”¨</span>' : '<span class="tag active">æ­£å¸¸</span>'));
        const safeName = (u.name || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/`/g, '\\`').replace(/\$/g, '\\$');
        const safeUUID = (u.uuid || '').replace(/'/g, "\\'");
        
        return `<tr><td><input type="checkbox" class="u-check" value="${safeUUID}"></td><td class="mono" onclick="copy('${safeUUID}')">${u.uuid}</td><td>${u.name}</td><td>${createDate}</td><td>${expiryText}</td><td>${statusHtml}</td><td class="actions"><div class="dropdown"><button class="btn-action btn-copy" onclick="toggleDropdown(event,'${safeUUID}')">è®¢é˜… â–¼</button><div class="dropdown-content" id="dropdown-${u.uuid}"><div class="dropdown-item original" onclick="copySubByType('${safeUUID}','original')"><span>ğŸ”—</span> åŸå§‹è®¢é˜…</div><div class="dropdown-item clash" onclick="copySubByType('${safeUUID}','clash')"><span>âš¡</span> Clash</div><div class="dropdown-item singbox" onclick="copySubByType('${safeUUID}','singbox')"><span>ğŸ“¦</span> SingBox</div><div class="dropdown-item surge" onclick="copySubByType('${safeUUID}','surge')"><span>ğŸŒŠ</span> Surge</div><div class="dropdown-item shadowrocket" onclick="copySubByType('${safeUUID}','shadowrocket')"><span>ğŸš€</span> Shadowrocket</div><div class="dropdown-item quantumult" onclick="copySubByType('${safeUUID}','quanx')"><span>ğŸ”®</span> Quantumult X</div><div class="dropdown-item v2ray" onclick="copySubByType('${safeUUID}','v2ray')"><span>âœˆï¸</span> V2Ray/Xray</div><div class="dropdown-item surfboard" onclick="copySubByType('${safeUUID}','surfboard')"><span>ğŸ„</span> Surfboard</div></div></div><button class="btn-action btn-edit" onclick="openEdit('${safeUUID}','${safeName}','${expiryVal}')">ç¼–è¾‘</button><button class="btn-action" style="background:#722ed1" onclick="resetUUID('${safeUUID}')">é‡ç½®UUID</button>${isEnabled&&!isExpired?`<button class="btn-action btn-secondary" onclick="toggleStatus('${safeUUID}',false)">ç¦ç”¨</button>`:''}${!isEnabled&&!isExpired?`<button class="btn-action btn-success" onclick="toggleStatus('${safeUUID}',true)">å¯ç”¨</button>`:''}<button class="btn-action btn-del" onclick="delUser('${safeUUID}')">åˆ é™¤</button></td></tr>`;
    }).join('');

    return `<!DOCTYPE html><html lang="zh-CN"><head><title>${siteName} æ§åˆ¶é¢æ¿</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><style>:root{--primary:#1890ff;--bg:#f0f2f5;--danger:#ff4d4f;--success:#52c41a;--warning:#faad14;--purple:#722ed1;--grey:#bfbfbf}*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:#333;height:100vh;overflow:hidden}.layout{display:flex;height:100vh}.sidebar{width:240px;background:#001529;color:white;overflow-y:auto}.sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,0.1)}.sidebar-header h1{color:white;font-size:18px}.sidebar-header .date{font-size:12px;color:rgba(255,255,255,0.65);margin-top:5px}.menu{list-style:none;padding:10px 0}.menu-item{padding:12px 20px;cursor:pointer;transition:all 0.3s;border-left:3px solid transparent;display:flex;align-items:center;gap:10px;color:rgba(255,255,255,0.85)}.menu-item:hover{background:rgba(255,255,255,0.1);color:white}.menu-item.active{background:var(--primary);border-left-color:#fff;color:white}.menu-item-icon{font-size:16px;width:20px;text-align:center}.main-content{flex:1;overflow-y:auto;background:var(--bg)}.content-header{background:white;padding:16px 24px;box-shadow:0 1px 4px rgba(0,0,0,0.08);position:sticky;top:0;z-index:10}.content-header h2{font-size:20px;margin:0}.content-body{padding:24px}.card{background:white;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}.card h3{margin-bottom:15px;color:#333;border-bottom:1px solid #eee;padding-bottom:10px}.section{display:none}.section.active{display:block}.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}label{display:block;margin-bottom:8px;font-size:14px;color:#666;font-weight:600}input[type=text],input[type=date],input[type=number],input[type=password],textarea,select{width:100%;padding:10px;border:1px solid #d9d9d9;border-radius:4px;font-family:inherit}input:focus,textarea:focus,select:focus{border-color:var(--primary);outline:none}textarea{resize:vertical;min-height:80px}button{padding:8px 16px;color:white;border:none;border-radius:4px;cursor:pointer;font-size:14px}button:hover{opacity:0.9}button:disabled{background:#ccc!important;cursor:not-allowed}.btn-primary{background:var(--primary)}.btn-danger{background:var(--danger)}.btn-success{background:var(--success)}.btn-warning{background:var(--warning)}.btn-secondary{background:var(--grey)}table{width:100%;border-collapse:collapse;font-size:14px}th,td{padding:12px 10px;text-align:left;border-bottom:1px solid #f0f0f0}th{background:#fafafa;color:#666;font-weight:600}tr:hover{background:#fdfdfd}.mono{font-family:monospace;color:var(--primary);cursor:pointer}.tag{font-size:12px;padding:2px 8px;border-radius:10px;font-weight:500}.tag.active{color:var(--success);background:#f6ffed;border:1px solid #b7eb8f}.tag.expired{color:var(--danger);background:#fff1f0;border:1px solid #ffa39e}.tag.disabled{color:#999;background:#f5f5f5;border:1px solid #d9d9d9}.actions{white-space:nowrap}.btn-action{padding:4px 10px;font-size:12px;margin-right:4px}.btn-copy{background:var(--purple)}.btn-edit{background:var(--warning)}.btn-del{background:#ff7875}.dropdown{position:relative;display:inline-block}.dropdown-content{display:none;position:absolute;right:0;top:100%;background:white;min-width:160px;box-shadow:0 4px 12px rgba(0,0,0,0.15);border-radius:6px;z-index:100;overflow:hidden}.dropdown-content.show{display:block}.dropdown-item{padding:10px 15px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:background 0.2s}.dropdown-item:hover{background:#f5f5f5}.dropdown-item span{font-size:14px}.dropdown-item.original{color:#722ed1}.dropdown-item.clash{color:#1890ff}.dropdown-item.singbox{color:#52c41a}.dropdown-item.surge{color:#13c2c2}.dropdown-item.shadowrocket{color:#ff4d4f}.dropdown-item.quantumult{color:#eb2f96}.dropdown-item.v2ray{color:#faad14}.dropdown-item.surfboard{color:#2f54eb}.config-item{display:flex;align-items:center;padding:8px 10px;background:white;border-bottom:1px solid #eee;cursor:move}.config-item:hover{background:#fafafa}.config-item.dragging{opacity:0.5;background:#e6f7ff}.drag-handle{cursor:move;color:#999;margin-right:10px;font-size:14px}.del-btn{color:#ff4d4f;cursor:pointer;padding:0 8px;font-size:16px;background:none;border:none}.batch-bar{margin-bottom:15px;display:none;gap:10px;align-items:center;background:#e6f7ff;padding:10px;border-radius:4px;border:1px solid #91d5ff}.batch-bar.show{display:flex}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:100}.modal{background:white;padding:25px;border-radius:8px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}.modal h3{margin-bottom:20px}#toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:10px 20px;border-radius:4px;opacity:0;pointer-events:none;transition:0.3s;z-index:200}#toast.show{opacity:1;bottom:50px}@media(max-width:768px){.grid{grid-template-columns:1fr}}.switch{position:relative;display:inline-block;width:44px;height:22px;cursor:pointer}.switch .slider{position:absolute;top:0;left:0;right:0;bottom:0;background:#d9d9d9;border-radius:22px;transition:0.4s}.switch .slider:before{content:'';position:absolute;height:18px;width:18px;left:2px;bottom:2px;background:white;border-radius:50%;transition:0.4s}.switch input:checked+.slider{background:#52c41a}.switch input:checked+.slider:before{transform:translateX(22px)}</style></head><body><div class="layout"><div class="sidebar"><div class="sidebar-header"><h1>${siteName}</h1><div class="date">${formatBeijingDate(Date.now())}</div><button onclick="adminLogout()" style="margin-top:10px;width:100%;padding:8px;background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:4px;cursor:pointer;font-size:13px">ğŸšª é€€å‡ºç™»å½•</button></div><ul class="menu"><li class="menu-item active" data-section="dashboard" onclick="switchSection('dashboard')"><span class="menu-item-icon">ğŸ“Š</span><span>ä»ªè¡¨ç›˜</span></li><li class="menu-item" data-section="users" onclick="switchSection('users')"><span class="menu-item-icon">ğŸ‘¥</span><span>ç”¨æˆ·ç®¡ç†</span></li><li class="menu-item" data-section="proxy-ips" onclick="switchSection('proxy-ips')"><span class="menu-item-icon">ğŸŒ</span><span>åä»£IP</span></li><li class="menu-item" data-section="best-domains" onclick="switchSection('best-domains')"><span class="menu-item-icon">â­</span><span>ä¼˜é€‰åŸŸå</span></li><li class="menu-item" data-section="plans" onclick="switchSection('plans')"><span class="menu-item-icon">ğŸ“¦</span><span>å¥—é¤ç®¡ç†</span></li><li class="menu-item" data-section="orders" onclick="switchSection('orders')"><span class="menu-item-icon">ğŸ’³</span><span>è®¢å•ç®¡ç†</span></li><li class="menu-item" data-section="announcements" onclick="switchSection('announcements')"><span class="menu-item-icon">ğŸ“¢</span><span>å…¬å‘Šç®¡ç†</span></li><li class="menu-item" data-section="payment" onclick="switchSection('payment')"><span class="menu-item-icon">ğŸ’°</span><span>æ”¯ä»˜æ¸ é“</span></li><li class="menu-item" data-section="invites" onclick="switchSection('invites')"><span class="menu-item-icon">ğŸ«</span><span>é‚€è¯·ç </span></li><li class="menu-item" data-section="password" onclick="switchSection('password')"><span class="menu-item-icon">ğŸ”</span><span>ä¿®æ”¹å¯†ç </span></li></ul></div><div class="main-content"><div id="section-dashboard" class="section active"><div class="content-header"><h2>ğŸ“Š ä»ªè¡¨ç›˜</h2></div><div class="content-body">
<div class="card"><h3 style="margin-bottom:15px">ç³»ç»Ÿè®¾ç½®</h3>
<div style="padding:15px;background:#f0f5ff;border-radius:8px;margin-bottom:15px"><div style="margin-bottom:8px"><span style="font-weight:600;display:block;margin-bottom:4px">ğŸ·ï¸ ç«™ç‚¹åç§°</span><div style="font-size:13px;color:#666">ç”¨äºæ˜¾ç¤ºéœ€è¦ç«™ç‚¹åç§°çš„åœ°æ–¹</div></div><input type="text" id="siteName" value="${settings.siteName||'CFly'}" onchange="updateSystemSettings()" placeholder="è¯·è¾“å…¥ç«™ç‚¹åç§°ï¼Œä¾‹å¦‚ï¼šCFly" style="width:100%;padding:10px;border:1px solid #d9d9d9;border-radius:4px;font-size:14px"></div>
<div style="padding:15px;background:#f8f9fa;border-radius:8px;margin-bottom:15px"><label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><div><span style="font-weight:600;display:block;margin-bottom:4px">å¼€æ”¾ç”¨æˆ·æ³¨å†Œ</span><div style="font-size:13px;color:#666">å¼€å¯åï¼Œç”¨æˆ·å¯ä»¥è‡ªåŠ©æ³¨å†Œè´¦å·ï¼›å…³é—­åï¼Œåªèƒ½ç”±ç®¡ç†å‘˜æ‰‹åŠ¨æ·»åŠ ç”¨æˆ·</div></div><div class="switch" onclick="toggleSwitch(event,'enableRegisterCheck')"><input type="checkbox" id="enableRegisterCheck" ${settings.enableRegister?'checked':''} onchange="updateSystemSettings()" style="display:none"><span class="slider" style="background:${settings.enableRegister?'#52c41a':'#d9d9d9'}"></span></div></label></div>
<div style="padding:15px;background:#fff7e6;border-radius:8px;margin-bottom:15px"><label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><div><span style="font-weight:600;display:block;margin-bottom:4px">è‡ªåŠ¨å®¡æ ¸è®¢å•</span><div style="font-size:13px;color:#666">å¼€å¯åï¼Œç”¨æˆ·è®¢è´­<b style="color:#ff4d4f">å…è´¹å¥—é¤ï¼ˆä»·æ ¼ä¸º0ï¼‰</b>å°†è‡ªåŠ¨å®¡æ ¸é€šè¿‡ï¼›ä»˜è´¹å¥—é¤ä»éœ€ç­‰å¾…æ”¯ä»˜æˆ–æ‰‹åŠ¨å®¡æ ¸</div></div><div class="switch" onclick="toggleSwitch(event,'autoApproveOrderCheck')"><input type="checkbox" id="autoApproveOrderCheck" ${settings.autoApproveOrder?'checked':''} onchange="updateSystemSettings()" style="display:none"><span class="slider" style="background:${settings.autoApproveOrder?'#52c41a':'#d9d9d9'}"></span></div></label></div>
<div style="padding:15px;background:#f6ffed;border-radius:8px;margin-bottom:15px"><label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><div><span style="font-weight:600;display:block;margin-bottom:4px">ğŸ æ–°ç”¨æˆ·æ³¨å†Œè¯•ç”¨</span><div style="font-size:13px;color:#666">å¼€å¯åï¼Œæ–°æ³¨å†Œç”¨æˆ·è‡ªåŠ¨è·å¾—å…è´¹è¯•ç”¨æ—¶é•¿ï¼›å…³é—­åæ–°ç”¨æˆ·éœ€è´­ä¹°å¥—é¤æ‰èƒ½ä½¿ç”¨</div></div><div class="switch" onclick="toggleSwitch(event,'enableTrialCheck')"><input type="checkbox" id="enableTrialCheck" ${settings.enableTrial?'checked':''} onchange="updateSystemSettings()" style="display:none"><span class="slider" style="background:${settings.enableTrial?'#52c41a':'#d9d9d9'}"></span></div></label><div id="trialDaysDiv" style="margin-top:12px;${settings.enableTrial?'':'opacity:0.5;pointer-events:none;'}"><label style="font-size:13px;color:#666;display:block;margin-bottom:5px">è¯•ç”¨æ—¶é•¿ï¼ˆå¤©ï¼‰</label><select id="trialDays" onchange="updateSystemSettings()" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px"><option value="1" ${settings.trialDays==1?'selected':''}>1 å¤©</option><option value="3" ${settings.trialDays==3?'selected':''}>3 å¤©</option><option value="7" ${!settings.trialDays||settings.trialDays==7?'selected':''}>7 å¤©</option><option value="14" ${settings.trialDays==14?'selected':''}>14 å¤©</option><option value="30" ${settings.trialDays==30?'selected':''}>30 å¤©</option></select></div></div>
<div style="padding:15px;background:#e6fffb;border-radius:8px;margin-bottom:15px"><label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><div><span style="font-weight:600;display:block;margin-bottom:4px">ğŸ« æ³¨å†Œéœ€è¦é‚€è¯·ç </span><div style="font-size:13px;color:#666">å¼€å¯åï¼Œç”¨æˆ·æ³¨å†Œæ—¶å¿…é¡»å¡«å†™æœ‰æ•ˆçš„é‚€è¯·ç ï¼›é‚€è¯·ç åœ¨"é‚€è¯·ç ç®¡ç†"ä¸­ç”Ÿæˆ</div></div><div class="switch" onclick="toggleSwitch(event,'requireInviteCodeCheck')"><input type="checkbox" id="requireInviteCodeCheck" ${settings.requireInviteCode?'checked':''} onchange="updateSystemSettings()" style="display:none"><span class="slider" style="background:${settings.requireInviteCode?'#52c41a':'#d9d9d9'}"></span></div></label></div>
<div style="padding:15px;background:#f0f5ff;border-radius:8px;margin-bottom:15px"><div style="margin-bottom:12px"><span style="font-weight:600;display:block;margin-bottom:4px">â±ï¸ è®¢å•è¿‡æœŸæ—¶é—´è®¾ç½®</span><div style="font-size:13px;color:#666">è®¾ç½®å¾…å®¡æ ¸è®¢å•å’Œæ”¯ä»˜è®¢å•çš„è‡ªåŠ¨è¿‡æœŸæ—¶é—´</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px"><div><label style="font-size:13px;color:#666;display:block;margin-bottom:5px">å¾…å®¡æ ¸è®¢å•è¿‡æœŸæ—¶é—´</label><select id="pendingOrderExpiry" onchange="updateSystemSettings()" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px"><option value="0" ${!settings.pendingOrderExpiry||settings.pendingOrderExpiry==0?'selected':''}>æ°¸ä¸è¿‡æœŸ</option><option value="30" ${settings.pendingOrderExpiry==30?'selected':''}>30åˆ†é’Ÿ</option><option value="60" ${settings.pendingOrderExpiry==60?'selected':''}>1å°æ—¶</option><option value="120" ${settings.pendingOrderExpiry==120?'selected':''}>2å°æ—¶</option><option value="360" ${settings.pendingOrderExpiry==360?'selected':''}>6å°æ—¶</option><option value="720" ${settings.pendingOrderExpiry==720?'selected':''}>12å°æ—¶</option><option value="1440" ${settings.pendingOrderExpiry==1440?'selected':''}>24å°æ—¶</option></select></div><div><label style="font-size:13px;color:#666;display:block;margin-bottom:5px">æ”¯ä»˜è®¢å•è¿‡æœŸæ—¶é—´</label><select id="paymentOrderExpiry" onchange="updateSystemSettings()" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px"><option value="15" ${!settings.paymentOrderExpiry||settings.paymentOrderExpiry==15?'selected':''}>15åˆ†é’Ÿ</option><option value="30" ${settings.paymentOrderExpiry==30?'selected':''}>30åˆ†é’Ÿ</option><option value="60" ${settings.paymentOrderExpiry==60?'selected':''}>1å°æ—¶</option><option value="120" ${settings.paymentOrderExpiry==120?'selected':''}>2å°æ—¶</option></select></div></div></div>
<div style="padding:15px;background:#e6fffb;border-radius:8px;margin-bottom:15px"><div style="margin-bottom:12px"><span style="font-weight:600;display:block;margin-bottom:4px">ğŸ”— ç”¨æˆ·å‰ç«¯å¿«æ·é“¾æ¥</span><div style="font-size:13px;color:#666">é…ç½®ç”¨æˆ·é¢æ¿å³ä¸Šè§’æ˜¾ç¤ºçš„å¿«æ·é“¾æ¥ï¼ˆå¦‚TGå®¢æœã€å®˜æ–¹ç¾¤ç»„ç­‰ï¼‰</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px"><div><label style="font-size:13px;color:#666;display:block;margin-bottom:5px">é“¾æ¥1 åç§°</label><input type="text" id="customLink1Name" value="${settings.customLink1Name||''}" onchange="updateSystemSettings()" placeholder="ä¾‹å¦‚ï¼šTGå®¢æœ" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px"></div><div><label style="font-size:13px;color:#666;display:block;margin-bottom:5px">é“¾æ¥1 åœ°å€</label><input type="text" id="customLink1Url" value="${settings.customLink1Url||''}" onchange="updateSystemSettings()" placeholder="ä¾‹å¦‚ï¼šhttps://t.me/xxx" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px"></div><div><label style="font-size:13px;color:#666;display:block;margin-bottom:5px">é“¾æ¥2 åç§°</label><input type="text" id="customLink2Name" value="${settings.customLink2Name||''}" onchange="updateSystemSettings()" placeholder="ä¾‹å¦‚ï¼šå®˜æ–¹ç¾¤ç»„" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px"></div><div><label style="font-size:13px;color:#666;display:block;margin-bottom:5px">é“¾æ¥2 åœ°å€</label><input type="text" id="customLink2Url" value="${settings.customLink2Url||''}" onchange="updateSystemSettings()" placeholder="ä¾‹å¦‚ï¼šhttps://t.me/xxx" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px"></div></div></div>
<div style="padding:15px;background:#fff1f0;border-radius:8px;margin-bottom:15px"><label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><div><span style="font-weight:600;display:block;margin-bottom:4px">ğŸ§¹ è‡ªåŠ¨æ¸…ç†éæ´»è·ƒç”¨æˆ·</span><div style="font-size:13px;color:#666">è‡ªåŠ¨åˆ é™¤æŒ‡å®šå¤©æ•°å†…æœªç™»å½•çš„éæ´»è·ƒç”¨æˆ·è´¦å·</div></div><div class="switch" onclick="toggleSwitch(event,'enableAutoCleanupCheck')"><input type="checkbox" id="enableAutoCleanupCheck" ${settings.enableAutoCleanup?'checked':''} onchange="updateSystemSettings()" style="display:none"><span class="slider" style="background:${settings.enableAutoCleanup?'#52c41a':'#d9d9d9'}"></span></div></label><div id="autoCleanupDiv" style="margin-top:12px;${settings.enableAutoCleanup?'':'opacity:0.5;pointer-events:none;'}"><label style="font-size:13px;color:#666;display:block;margin-bottom:5px">ä¿ç•™å¤©æ•°ï¼š</label><div style="display:flex;align-items:center;gap:10px"><input type="number" id="autoCleanupDays" value="${settings.autoCleanupDays||7}" min="1" max="365" onchange="updateSystemSettings()" style="width:80px;padding:8px;border:1px solid #d9d9d9;border-radius:4px"><span style="font-size:13px;color:#666">å¤©ï¼ˆè¶…è¿‡æ­¤å¤©æ•°æœªç™»å½•çš„ç”¨æˆ·å°†è¢«è‡ªåŠ¨åˆ é™¤ï¼‰</span></div></div></div>
</div>
<div class="card"><h3 style="margin-bottom:15px">ç³»ç»Ÿæ¦‚è§ˆ</h3><div class="grid" style="grid-template-columns:repeat(4,1fr);gap:15px"><div style="padding:20px;background:#e6f7ff;border-radius:8px;text-align:center"><div style="font-size:32px;font-weight:bold;color:var(--primary)">${usersData.length}</div><div style="margin-top:8px;color:#666">æ€»ç”¨æˆ·æ•°</div></div><div style="padding:20px;background:#f6ffed;border-radius:8px;text-align:center"><div style="font-size:32px;font-weight:bold;color:var(--success)">${usersData.filter(u=>u.enabled&&(!u.expiry||u.expiry>Date.now())).length}</div><div style="margin-top:8px;color:#666">æ´»è·ƒç”¨æˆ·</div></div><div style="padding:20px;background:#fff7e6;border-radius:8px;text-align:center"><div style="font-size:32px;font-weight:bold;color:var(--warning)" id="dashConfigNodes">0</div><div style="margin-top:8px;color:#666">é…ç½®èŠ‚ç‚¹æ•°</div></div><div style="padding:20px;background:#fff1f0;border-radius:8px;text-align:center"><div style="font-size:32px;font-weight:bold;color:var(--danger)">${usersData.filter(u=>u.expiry&&u.expiry<Date.now()).length}</div><div style="margin-top:8px;color:#666">å·²è¿‡æœŸç”¨æˆ·</div></div></div></div>
<div class="card"><h3 style="margin-bottom:15px">å¿«æ·æ“ä½œ</h3><div style="display:flex;gap:10px;flex-wrap:wrap"><button onclick="switchSection('proxy-ips')" class="btn-primary">ğŸŒ åä»£ IP</button><button onclick="switchSection('best-domains')" class="btn-primary">â­ ä¼˜é€‰åŸŸå</button><button onclick="switchSection('users')" class="btn-primary">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</button></div></div>
<div class="card"><h3 style="margin-bottom:15px">ğŸ“¦ æ•°æ®å¤‡ä»½</h3><div style="padding:15px;background:#f6ffed;border-radius:8px;margin-bottom:15px"><div style="margin-bottom:10px"><span style="font-weight:600;display:block;margin-bottom:4px">ğŸ“¥ å¯¼å‡ºå…¨éƒ¨æ•°æ®</span><div style="font-size:13px;color:#666">å¯¼å‡ºç”¨æˆ·ã€è®¾ç½®ã€å¥—é¤ã€è®¢å•ã€å…¬å‘Šã€é‚€è¯·ç ç­‰æ‰€æœ‰æ•°æ®ä¸º JSON æ–‡ä»¶</div></div><button onclick="exportAllData()" class="btn-success" style="margin-top:10px">ğŸ“¥ å¯¼å‡ºæ•°æ®</button></div><div style="padding:15px;background:#e6f7ff;border-radius:8px;margin-bottom:15px"><div style="margin-bottom:10px"><span style="font-weight:600;display:block;margin-bottom:4px">ğŸ“¤ å¯¼å…¥æ•°æ®</span><div style="font-size:13px;color:#666">ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®ï¼Œå°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ</div></div><input type="file" id="importFileInput" accept=".json" style="display:none" onchange="importAllDataFile(this)"><button onclick="document.getElementById('importFileInput').click()" class="btn-primary" style="margin-top:10px">ğŸ“¤ é€‰æ‹©æ–‡ä»¶å¯¼å…¥</button></div><div style="padding:10px;background:#fff7e6;border-radius:4px;font-size:12px;color:#d46b08">âš ï¸ å¯¼å…¥æ“ä½œä¼šè¦†ç›–ç°æœ‰æ•°æ®ï¼Œå»ºè®®å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½</div></div>
</div></div><div id="section-users" class="section"><div class="content-header"><h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2></div><div class="content-body"><div class="card"><h3>æ·»åŠ ç”¨æˆ·</h3><div class="grid"><div><label>ç”¨æˆ·åç§°</label><input type="text" id="addName" placeholder="ç”¨æˆ·å¤‡æ³¨å"></div><div><label>åˆ°æœŸæ—¥æœŸ</label><input type="date" id="addExpiry"></div></div><div class="grid" style="margin-top:15px"><div><label>å‰ç«¯ç”¨æˆ·å</label><input type="text" id="addFrontUsername" placeholder="ä¸å¡«åˆ™éšæœºç”Ÿæˆ"></div><div><label>å‰ç«¯å¯†ç </label><input type="password" id="addFrontPassword" placeholder="ä¸å¡«åˆ™ä¸ç”¨æˆ·åç›¸åŒ"></div></div><div style="margin-top:15px"><label>æ‰¹é‡UUIDå¯¼å…¥</label><textarea id="addUUIDs" placeholder="ä¸€è¡Œä¸€ä¸ªUUIDï¼Œæ”¯æŒé€—å·åˆ†éš”&#10;ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆå•ä¸ªUUID" style="min-height:80px"></textarea></div><div style="margin-top:15px"><button onclick="addUser()" class="btn-primary">æ·»åŠ ç”¨æˆ·</button></div></div><div class="card"><h3>ç”¨æˆ·åˆ—è¡¨ (${usersData.length})</h3><div class="batch-bar" id="batchBar"><span>å·²é€‰ <b id="selCount">0</b> ä¸ªç”¨æˆ·ï¼š</span><button onclick="batchEnable()" class="btn-success">æ‰¹é‡å¯ç”¨</button><button onclick="batchDisable()" class="btn-warning">æ‰¹é‡ç¦ç”¨</button><button onclick="batchDelete()" class="btn-danger">æ‰¹é‡åˆ é™¤</button></div><div style="overflow-x:auto"><table><thead><tr><th><input type="checkbox" id="checkAll" onchange="toggleCheckAll()"></th><th>UUID</th><th>åç§°</th><th>åˆ›å»ºæ—¶é—´</th><th>åˆ°æœŸæ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>${userRows}</tbody></table></div></div></div></div><div id="section-proxy-ips" class="section"><div class="content-header"><h2>ğŸŒ åä»£ IP é…ç½®</h2></div><div class="content-body">
<div class="card"><h3 style="margin-bottom:15px">èŠ‚ç‚¹è®¢é˜…åœ°å€</h3>
<div style="margin-bottom:20px;padding:15px;background:#fff7e6;border:1px solid #ffd591;border-radius:4px"><label style="color:#d46b08">èŠ‚ç‚¹è®¢é˜…åœ°å€ (ç”¨äºç”Ÿæˆè®¢é˜…é“¾æ¥)</label><input type="text" id="subUrl" value="${settings.subUrl||''}" placeholder="æ”¯æŒå¤šä¸ªåœ°å€ç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼Œç”¨æˆ·å¤åˆ¶æ—¶éšæœºè·å–ä¸€ä¸ª"><div style="margin-top:8px;font-size:12px;color:#666">ğŸ’¡ æ”¯æŒå¤šä¸ªåœ°å€ï¼Œç”¨è‹±æ–‡é€—å·(,)åˆ†éš”ï¼Œç”¨æˆ·å¤åˆ¶è®¢é˜…æ—¶ä¼šéšæœºåˆ†é…ä¸€ä¸ªåœ°å€</div></div>
<div style="margin-bottom:20px;padding:15px;background:#e6f7ff;border:1px solid #91d5ff;border-radius:4px"><label style="color:#0050b3">å®˜ç½‘åœ°å€ (æ˜¾ç¤ºåœ¨è®¢é˜…èŠ‚ç‚¹åˆ—è¡¨ä¸­)</label><input type="text" id="websiteUrl" value="${settings.websiteUrl||''}" placeholder="è¯·è¾“å…¥å®˜ç½‘åœ°å€, ä¾‹å¦‚: example.com (ä¸éœ€è¦åŠ  https://)"><div style="margin-top:8px;font-size:12px;color:#666">ğŸ’¡ æ­¤åœ°å€ä¼šæ˜¾ç¤ºåœ¨è®¢é˜…èŠ‚ç‚¹çš„åˆ«åä¸­ï¼Œæ–¹ä¾¿ç”¨æˆ·è¯†åˆ«å®˜ç½‘</div></div>
<div style="margin-bottom:20px;padding:15px;background:#fff3e0;border:1px solid #ffcc80;border-radius:4px"><label style="color:#e65100">ç½‘ç«™åŸºç¡€URL (ç”¨äºæ”¯ä»˜å›è°ƒ)</label><input type="text" id="baseUrl" value="${settings.baseUrl||''}" onchange="updateSystemSettings()" placeholder="ä¾‹å¦‚: https://ideal-dollop-r45wwvv95vjqhpqp-3000.app.github.dev"><div style="margin-top:8px;font-size:12px;color:#666">ğŸ’¡ å¡«å†™å®Œæ•´çš„ç½‘ç«™è®¿é—®åœ°å€ï¼Œç”¨äºç”Ÿæˆæ”¯ä»˜å›è°ƒURLã€‚ç•™ç©ºåˆ™è‡ªåŠ¨è·å–å½“å‰è®¿é—®åœ°å€ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰</div></div>
</div>
<div class="card"><h3 style="margin-bottom:15px">é»˜è®¤åä»£ IP åˆ—è¡¨</h3>
<div style="margin-bottom:10px;padding:10px;background:#f0f9ff;border:1px solid #bae7ff;border-radius:4px;font-size:13px;color:#0050b3">ğŸ’¡ <b>æ™ºèƒ½æç¤ºï¼š</b>åœ¨ä»£ç†åœ°å€ä¸­åŒ…å«åœ°åŒºæ ‡è¯†ï¼ˆå¦‚ HK/JP/US/SGï¼‰ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç›®æ ‡åœ°å€è‡ªåŠ¨é€‰æ‹©åŒåœ°åŒºä»£ç†ï¼Œæå‡è¿æ¥é€Ÿåº¦ã€‚</div>
<div style="margin-bottom:15px"><textarea id="proxyIPInput" placeholder="æ‰¹é‡æ·»åŠ ï¼Œä¸€è¡Œä¸€ä¸ª&#10;æ”¯æŒåœ°ç†ä½ç½®æ ‡è¯†ï¼ŒèŠ‚ç‚¹ä¼šæ™ºèƒ½é€‰æ‹©å°±è¿‘ä»£ç†&#10;ä¾‹å¦‚: ProxyIP.HK.example.net:443&#10;ä¾‹å¦‚: ProxyIP.JP.example.net&#10;ä¾‹å¦‚: 1.2.3.4 (è‡ªåŠ¨è¡¥å…¨:443)" style="width:100%;min-height:100px;padding:10px;border:1px solid #d9d9d9;border-radius:4px;font-family:monospace"></textarea></div>
<div style="margin-bottom:15px;display:flex;gap:10px"><button onclick="addProxyIPs()" class="btn-success">æ·»åŠ åˆ°åˆ—è¡¨</button><button onclick="clearProxyIPs()" class="btn-danger">æ¸…ç©ºåˆ—è¡¨</button></div>
<div id="proxyIPList" style="border:1px solid #eee;border-radius:4px;padding:10px;max-height:200px;overflow-y:auto;background:#fafafa;margin-bottom:15px"></div>
<div style="text-align:right"><button onclick="saveProxySettings()" class="btn-primary" style="padding:10px 30px">ä¿å­˜é…ç½®</button></div>
</div></div></div><div id="section-best-domains" class="section"><div class="content-header"><h2>â­ ä¼˜é€‰åŸŸåç®¡ç†</h2></div><div class="content-body"><div class="card"><div style="margin-bottom:20px;padding:15px;background:#e6f7ff;border:1px solid #91d5ff;border-radius:4px;font-size:13px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:16px">â„¹ï¸</span><strong style="color:#0050b3">å…³äºå®šæ—¶è‡ªåŠ¨æ›´æ–°åŠŸèƒ½</strong></div><div style="color:#096dd9;line-height:1.6"><p style="margin:5px 0">â€¢ <strong>Dockeréƒ¨ç½²</strong>: æ”¯æŒé€šè¿‡cronå®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ›´æ–°ä¼˜é€‰IP</p><p style="margin:5px 0">â€¢ <strong>æ‰‹åŠ¨è·å–</strong>: ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç«‹å³è·å–æœ€æ–°ä¼˜é€‰IP</p><p style="margin:5px 0">â€¢ <strong>Cron è¡¨è¾¾å¼</strong>: <code style="background:#fff;padding:2px 6px;border-radius:3px">*/15 * * * *</code> (æ¯15åˆ†é’Ÿæ‰§è¡Œ)</p><p style="margin:5px 0">â€¢ <strong>ä¸‹æ¬¡æ›´æ–°</strong>: <span id="nextUpdateCountdown" style="color:#ff4d4f;font-weight:600">è®¡ç®—ä¸­...</span></p></div></div><h3>ä¼˜é€‰åŸŸååˆ—è¡¨</h3><div style="margin-bottom:15px"><textarea id="bestDomainInput" placeholder="æ‰¹é‡æ·»åŠ ï¼Œä¸€è¡Œä¸€ä¸ª&#10;æ ¼å¼: åŸŸå/IP:ç«¯å£#åˆ«å&#10;ä¾‹å¦‚: www.visa.com:443#é¦™æ¸¯&#10;ä¾‹å¦‚: 104.16.88.20:443#ç¾å›½" style="width:100%;min-height:100px;padding:10px;border:1px solid #d9d9d9;border-radius:4px;font-family:monospace"></textarea></div><div style="margin-bottom:15px;display:flex;gap:10px"><button onclick="addBestDomains()" class="btn-success">æ‰¹é‡æ·»åŠ </button><button onclick="fetchBestIPs('v4')" class="btn-primary" style="flex:1">ğŸš€ è‡ªåŠ¨è·å– IPv4 ä¼˜é€‰</button><button onclick="fetchBestIPs('v6')" class="btn-primary" style="flex:1">ğŸš€ è‡ªåŠ¨è·å– IPv6 ä¼˜é€‰</button><button onclick="clearBestDomains()" class="btn-danger">æ¸…ç©ºåˆ—è¡¨</button></div><div id="bestDomainList" style="border:1px solid #eee;border-radius:4px;padding:10px;max-height:300px;overflow-y:auto;background:#fafafa;min-height:100px"></div><div style="margin-top:15px;text-align:right"><button onclick="saveBestDomainSettings()" class="btn-primary" style="width:120px">ä¿å­˜é…ç½®</button></div></div></div></div><div id="section-plans" class="section"><div class="content-header"><h2>ğŸ“¦ å¥—é¤ç®¡ç†</h2></div><div class="content-body"><div class="card"><h3>æ·»åŠ æ–°å¥—é¤</h3><div class="grid"><div><label>å¥—é¤åç§°</label><input type="text" id="planName" placeholder="ä¾‹å¦‚ï¼šæœˆåº¦å¥—é¤"></div><div><label>æ—¶é•¿(å¤©)</label><input type="number" id="planDuration" placeholder="30" min="1"></div></div><div style="margin-top:10px"><label>å¥—é¤æè¿°</label><textarea id="planDescription" placeholder="å¥—é¤è¯´æ˜..." style="min-height:60px"></textarea></div><div style="margin-top:10px"><label>ä»·æ ¼(Â¥)</label><input type="number" id="planPrice" placeholder="0" min="0" step="0.01"></div><div style="margin-top:15px"><button onclick="addPlan()" class="btn-primary">æ·»åŠ å¥—é¤</button></div></div><div class="card"><h3>å¥—é¤åˆ—è¡¨</h3><div id="plansList">åŠ è½½ä¸­...</div></div></div></div><div id="section-orders" class="section"><div class="content-header"><h2>ğŸ’³ è®¢å•ç®¡ç†</h2></div><div class="content-body"><div class="card"><div style="margin-bottom:15px;display:flex;align-items:center;justify-content:space-between"><div style="display:flex;align-items:center;gap:15px"><h3 style="margin:0">è®¢å•åˆ—è¡¨</h3><select id="orderStatusFilter" onchange="loadOrders()" style="padding:5px 10px;border:1px solid #d9d9d9;border-radius:4px"><option value="all" selected>å…¨éƒ¨è®¢å•</option><option value="pending">å¾…å®¡æ ¸</option><option value="approved">å·²é€šè¿‡</option><option value="rejected">å·²æ‹’ç»</option></select></div><div id="orderBatchBar" style="display:none;align-items:center;gap:10px"><span>å·²é€‰ <b id="orderSelCount">0</b> ä¸ªè®¢å•ï¼š</span><button onclick="batchOrderAction('approve')" class="btn-action" style="background:#52c41a">æ‰¹é‡é€šè¿‡</button><button onclick="batchOrderAction('reject')" class="btn-action btn-del">æ‰¹é‡æ‹’ç»</button></div></div><div id="ordersList">åŠ è½½ä¸­...</div></div></div></div><div id="section-announcements" class="section"><div class="content-header"><h2>ğŸ“¢ å…¬å‘Šç®¡ç†</h2></div><div class="content-body"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px"><h3 style="margin:0">å…¬å‘Šåˆ—è¡¨</h3><button onclick="openAddAnnouncement()" class="btn-primary">+ æ·»åŠ å…¬å‘Š</button></div><div id="announcementsList">åŠ è½½ä¸­...</div></div></div></div><div id="section-payment" class="section"><div class="content-header"><h2>ğŸ’° æ”¯ä»˜é€šé“é…ç½®</h2></div><div class="content-body">
<div class="card">
<div style="margin-bottom:20px;padding:15px;background:#e6f7ff;border:1px solid #91d5ff;border-radius:8px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:16px">â„¹ï¸</span><strong style="color:#0050b3">BEpusdt å¯¹æ¥è¯´æ˜</strong></div><div style="color:#096dd9;line-height:1.6;font-size:14px"><p style="margin:5px 0">â€¢ æ”¯æŒå¯¹æ¥ <a href="https://github.com/v03413/BEpusdt" target="_blank" style="color:#1890ff">BEpusdt</a> USDT æ”¶æ¬¾ç½‘å…³</p><p style="margin:5px 0">â€¢ API åœ°å€å¡«å†™ BEpusdt æœåŠ¡åœ°å€ (å¦‚: https://epusdt.example.com)</p><p style="margin:5px 0">â€¢ API Token åœ¨ BEpusdt çš„ conf.toml ä¸­é…ç½®</p><p style="margin:5px 0">â€¢ æ”¯æŒå¤šç§äº¤æ˜“ç±»å‹: usdt.trc20, usdt.polygon, usdt.arbitrum ç­‰</p></div></div>
<h3 style="margin-bottom:15px">æ·»åŠ æ”¯ä»˜é€šé“</h3>
<div class="grid"><div><label>é€šé“åç§°</label><input type="text" id="payChannelName" placeholder="ä¾‹å¦‚ï¼šUSDT-TRC20"></div><div><label>é€šé“ä»£ç </label><input type="text" id="payChannelCode" placeholder="ä¾‹å¦‚ï¼šusdt.trc20"></div></div>
<div style="margin-top:10px"><label>API åœ°å€</label><input type="text" id="payChannelApiUrl" placeholder="BEpusdt æœåŠ¡åœ°å€ï¼Œä¾‹å¦‚ï¼šhttps://epusdt.example.com"></div>
<div style="margin-top:10px"><label>API Token</label><input type="text" id="payChannelApiToken" placeholder="BEpusdt API è®¤è¯ä»¤ç‰Œ"></div>
<div style="margin-top:15px"><button onclick="savePaymentChannel()" class="btn-primary">æ·»åŠ é€šé“</button></div>
</div>
<div class="card"><h3 style="margin-bottom:15px">æ”¯ä»˜é€šé“åˆ—è¡¨</h3><div id="paymentChannelsList"></div></div></div></div><div id="section-invites" class="section"><div class="content-header"><h2>ğŸ« é‚€è¯·ç ç®¡ç†</h2></div><div class="content-body"><div class="card"><div style="margin-bottom:20px;padding:15px;background:#f6ffed;border:1px solid #b7eb8f;border-radius:8px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:16px">ğŸ’¡</span><strong style="color:#389e0d">é‚€è¯·ç ä½¿ç”¨è¯´æ˜</strong></div><div style="color:#52c41a;line-height:1.6;font-size:14px"><p style="margin:5px 0">â€¢ å¼€å¯"å¼€æ”¾ç”¨æˆ·æ³¨å†Œ"åï¼Œå¯é…åˆ"éœ€è¦é‚€è¯·ç "é™åˆ¶æ³¨å†Œ</p><p style="margin:5px 0">â€¢ æ¯ä¸ªé‚€è¯·ç å¯è®¾ç½®ä½¿ç”¨æ¬¡æ•°ï¼Œç”¨å®Œè‡ªåŠ¨å¤±æ•ˆ</p><p style="margin:5px 0">â€¢ å¯è®¾ç½®é‚€è¯·ç å…³è”çš„è¯•ç”¨å¤©æ•°ï¼Œæ³¨å†Œç”¨æˆ·è‡ªåŠ¨è·å¾—å¯¹åº”æ—¶é•¿</p></div></div><h3 style="margin-bottom:15px">ç”Ÿæˆé‚€è¯·ç </h3><div class="grid"><div><label>é‚€è¯·ç  <span style="color:#999;font-size:12px">(ç•™ç©ºéšæœºç”Ÿæˆ)</span></label><input type="text" id="inviteCode" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ8ä½é‚€è¯·ç "></div><div><label>å¯ä½¿ç”¨æ¬¡æ•°</label><input type="number" id="inviteMaxUses" value="1" min="1" placeholder="é»˜è®¤1æ¬¡"></div></div><div class="grid" style="margin-top:10px"><div><label>èµ é€è¯•ç”¨å¤©æ•° <span style="color:#999;font-size:12px">(0è¡¨ç¤ºä¸èµ é€)</span></label><input type="number" id="inviteTrialDays" value="0" min="0" placeholder="æ³¨å†Œåèµ é€çš„å¤©æ•°"></div><div><label>å¤‡æ³¨</label><input type="text" id="inviteRemark" placeholder="å¯é€‰ï¼Œä¾‹å¦‚ï¼šç»™æŸæ¸ é“"></div></div><div style="margin-top:15px"><button onclick="createInviteCode()" class="btn-primary">ç”Ÿæˆé‚€è¯·ç </button></div></div><div class="card"><h3 style="margin-bottom:15px">é‚€è¯·ç åˆ—è¡¨</h3><div id="inviteCodesList">åŠ è½½ä¸­...</div></div></div></div><div id="section-password" class="section"><div class="content-header"><h2>ğŸ” ä¿®æ”¹å¯†ç </h2></div><div class="content-body"><div class="card"><h3>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h3><div style="margin-bottom:15px"><label>å½“å‰å¯†ç </label><input type="password" id="oldPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " autocomplete="current-password"></div><div style="margin-bottom:15px"><label>æ–°å¯†ç </label><input type="password" id="newPassword" placeholder="è‡³å°‘6ä½" autocomplete="new-password"></div><div style="margin-bottom:15px"><label>ç¡®è®¤æ–°å¯†ç </label><input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " autocomplete="new-password"></div><div style="margin-top:20px"><button onclick="changePassword()" class="btn-primary" style="width:100%;padding:15px;font-size:16px">ğŸ” ä¿®æ”¹å¯†ç </button></div></div></div></div><div id="section-data" class="section"><div class="content-header"><h2>ğŸ“¦ æ•°æ®ç®¡ç†</h2></div><div class="content-body"><div class="card"><h3>æ•°æ®å¯¼å‡º</h3><p style="margin-bottom:15px;color:#666">å¯¼å‡ºæ‰€æœ‰ç³»ç»Ÿæ•°æ®ï¼ˆç”¨æˆ·ã€è®¢å•ã€å¥—é¤ç­‰ï¼‰ä¸ºJSONæ ¼å¼</p><button onclick="exportData()" class="btn-primary" style="width:100%;padding:15px;font-size:16px">ğŸ“¥ å¯¼å‡ºæ•°æ®</button></div><div class="card"><h3>æ•°æ®å¯¼å…¥</h3><p style="margin-bottom:15px;color:#ff4d4f">âš ï¸ è­¦å‘Šï¼šæ•°æ®å¯¼å…¥åŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·è°¨æ…ä½¿ç”¨</p><input type="file" id="importFile" accept=".json" style="margin-bottom:15px"><button onclick="importData()" class="btn-warning" style="width:100%;padding:15px;font-size:16px">ğŸ“¤ å¯¼å…¥æ•°æ®</button></div></div></div><div id="section-logs" class="section"><div class="content-header"><h2>ğŸ”” ç³»ç»Ÿæ—¥å¿—</h2></div><div class="content-body"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px"><h3 style="margin:0">ç³»ç»Ÿæ“ä½œæ—¥å¿—</h3><button onclick="clearLogs()" class="btn-danger">æ¸…ç©ºæ—¥å¿—</button></div><div id="logsList" style="border:1px solid #eee;border-radius:4px;padding:10px;max-height:500px;overflow-y:auto;background:#fafafa">åŠ è½½ä¸­...</div></div></div></div><div id="section-stats" class="section"><div class="content-header"><h2>ğŸ“Š æ•°æ®ç»Ÿè®¡</h2></div><div class="content-body"><div class="card"><h3>ç³»ç»Ÿæ¦‚è§ˆ</h3><div id="statsOverview" class="grid">åŠ è½½ä¸­...</div></div><div class="card"><h3>ç”¨æˆ·å¢é•¿è¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰</h3><div id="userTrend" style="padding:20px">åŠ è½½ä¸­...</div></div><div class="card"><h3>è®¢å•ç»Ÿè®¡ï¼ˆæœ€è¿‘7å¤©ï¼‰</h3><div id="orderTrend" style="padding:20px">åŠ è½½ä¸­...</div></div></div></div></div><div class="modal-overlay" id="editModal"><div class="modal"><h3>ç¼–è¾‘ç”¨æˆ·</h3><input type="hidden" id="editUUID"><div style="margin-bottom:15px"><label>åç§°</label><input type="text" id="editName"></div><div style="margin-bottom:15px"><label>åˆ°æœŸæ—¥æœŸ</label><input type="date" id="editExpiry"></div><div style="margin-bottom:15px"><label>å‰ç«¯ç”¨æˆ·å</label><input type="text" id="editFrontUsername" placeholder="ä¿®æ”¹å‰ç«¯ç™»å½•ç”¨æˆ·å"></div><div style="margin-bottom:15px"><label>å‰ç«¯å¯†ç </label><input type="password" id="editFrontPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç "></div><div style="display:flex;gap:10px"><button onclick="saveEdit()" class="btn-primary">ä¿å­˜</button><button onclick="closeEdit()" style="background:#999">å–æ¶ˆ</button></div></div></div><div class="modal-overlay" id="editPlanModal"><div class="modal"><h3>ç¼–è¾‘å¥—é¤</h3><input type="hidden" id="editPlanId"><div style="margin-bottom:15px"><label>å¥—é¤åç§°</label><input type="text" id="editPlanName"></div><div style="margin-bottom:15px"><label>æ—¶é•¿(å¤©)</label><input type="number" id="editPlanDuration" min="1"></div><div style="margin-bottom:15px"><label>å¥—é¤æè¿°</label><textarea id="editPlanDescription" style="min-height:60px"></textarea></div><div style="margin-bottom:15px"><label>ä»·æ ¼</label><input type="number" id="editPlanPrice" min="0" step="0.01"></div><div style="display:flex;gap:10px"><button onclick="savePlanEdit()" class="btn-primary">ä¿å­˜</button><button onclick="closePlanEdit()" style="background:#999">å–æ¶ˆ</button></div></div></div><div class="modal-overlay" id="editAnnouncementModal"><div class="modal" style="max-width:600px"><h3 id="announcementModalTitle">æ·»åŠ å…¬å‘Š</h3><input type="hidden" id="editAnnouncementId"><div style="margin-bottom:15px"><label>å…¬å‘Šæ ‡é¢˜</label><input type="text" id="editAnnouncementTitle" placeholder="ä¾‹å¦‚ï¼šç³»ç»Ÿç»´æŠ¤é€šçŸ¥"></div><div style="margin-bottom:15px"><label>å…¬å‘Šå†…å®¹</label><textarea id="editAnnouncementContent" placeholder="æ”¯æŒæ¢è¡Œï¼Œæœ€å¤š500å­—" style="min-height:120px" maxlength="500"></textarea></div><div style="margin-bottom:15px"><label style="display:flex;align-items:center;gap:10px"><input type="checkbox" id="editAnnouncementEnabled" checked style="width:auto"><span>å¯ç”¨æ­¤å…¬å‘Š</span></label></div><div style="text-align:right"><button onclick="closeAnnouncementEdit()" style="background:#999;margin-right:10px">å–æ¶ˆ</button><button onclick="saveAnnouncementEdit()" class="btn-primary">ä¿å­˜</button></div></div></div><div class="modal-overlay" id="editInviteCodeModal"><div class="modal"><h3>ç¼–è¾‘é‚€è¯·ç </h3><input type="hidden" id="editInviteId"><div style="margin-bottom:15px"><label>é‚€è¯·ç </label><input type="text" id="editInviteCode" placeholder="é‚€è¯·ç "></div><div style="margin-bottom:15px"><label>æœ€å¤§ä½¿ç”¨æ¬¡æ•°</label><input type="number" id="editInviteMaxUses" min="1"></div><div style="margin-bottom:15px"><label>å·²ä½¿ç”¨æ¬¡æ•°</label><input type="number" id="editInviteUsedCount" disabled style="background:#f5f5f5"></div><div style="margin-bottom:15px"><label>èµ é€å¤©æ•°</label><input type="number" id="editInviteTrialDays" min="0"></div><div style="margin-bottom:15px"><label>å¤‡æ³¨</label><input type="text" id="editInviteRemark"></div><div style="display:flex;gap:10px"><button onclick="saveInviteEdit()" class="btn-primary">ä¿å­˜</button><button onclick="closeInviteEdit()" style="background:#999">å–æ¶ˆ</button></div></div></div><div class="modal-overlay" id="editPaymentChannelModal"><div class="modal"><h3>ç¼–è¾‘æ”¯ä»˜é€šé“</h3><input type="hidden" id="editPayChannelId"><div style="margin-bottom:15px"><label>é€šé“åç§°</label><input type="text" id="editPayChannelName" placeholder="ä¾‹å¦‚ï¼šUSDT-TRC20"></div><div style="margin-bottom:15px"><label>é€šé“ä»£ç </label><input type="text" id="editPayChannelCode" placeholder="ä¾‹å¦‚ï¼šusdt.trc20"></div><div style="margin-bottom:15px"><label>API åœ°å€</label><input type="text" id="editPayChannelApiUrl" placeholder="BEpusdt æœåŠ¡åœ°å€"></div><div style="margin-bottom:15px"><label>API Token</label><input type="text" id="editPayChannelApiToken" placeholder="BEpusdt API è®¤è¯ä»¤ç‰Œ"></div><div style="display:flex;gap:10px"><button onclick="savePaymentChannelEdit()" class="btn-primary">ä¿å­˜</button><button onclick="closePaymentChannelEdit()" style="background:#999">å–æ¶ˆ</button></div></div></div><div id="toast"></div><script>
function toggleSwitch(event, checkboxId){
  event.preventDefault();
  event.stopPropagation();
  const checkbox = document.getElementById(checkboxId);
  if(!checkbox)return;
  checkbox.checked = !checkbox.checked;
  const slider = checkbox.parentElement.querySelector('.slider');
  if(slider) slider.style.background = checkbox.checked ? '#52c41a' : '#d9d9d9';
  if(checkboxId === 'enableTrialCheck'){
    const div = document.getElementById('trialDaysDiv');
    if(div) div.style = checkbox.checked ? 'margin-top:12px' : 'margin-top:12px;opacity:0.5;pointer-events:none;';
  }
  if(checkboxId === 'enableAutoCleanupCheck'){
    const div = document.getElementById('autoCleanupDiv');
    if(div) div.style = checkbox.checked ? 'margin-top:12px' : 'margin-top:12px;opacity:0.5;pointer-events:none;';
  }
  updateSystemSettings();
}

function escapeHtml(str){
  if(!str)return'';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}



async function loadSettings(){
  try{
    const res = await fetch('/api/admin/getSystemSettings');
    const data = await res.json();
    if(data.success){
      settings = data.settings;
      // æ›´æ–°è¡¨å•å…ƒç´ 
      if(document.getElementById('subUrl')) document.getElementById('subUrl').value = settings.subUrl || '';
      if(document.getElementById('websiteUrl')) document.getElementById('websiteUrl').value = settings.websiteUrl || '';
      if(document.getElementById('baseUrl')) document.getElementById('baseUrl').value = settings.baseUrl || '';
      // ä¸å†å†™å…¥ textareaï¼ŒåªåŒæ­¥æ•°ç»„
      // åŒæ­¥ proxyIPsData æ•°ç»„
      if(typeof proxyIPsData !== 'undefined') proxyIPsData = settings.proxyIPs || [];
      // åŒæ­¥ bestDomainsData æ•°ç»„
      if(typeof bestDomainsData !== 'undefined') bestDomainsData = settings.bestDomains || [];
      // æ¸²æŸ“åˆ—è¡¨
      if(typeof renderProxyIPList === 'function') renderProxyIPList();
      if(typeof renderBestDomainList === 'function') renderBestDomainList();
    }
  }catch(e){console.error(e)}
}

function showToast(msg,type){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.background=type==='error'?'#ff4d4f':type==='success'?'#52c41a':'rgba(0,0,0,0.8)';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}

function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}function copy(text){navigator.clipboard.writeText(text).then(()=>toast('å·²å¤åˆ¶: '+text.substring(0,20)+'...'))}function copySubOriginal(uuid){const subUrl=document.getElementById('subUrl').value||window.location.origin;const url=subUrl.includes('://')?subUrl+'/'+uuid:'https://'+subUrl+'/'+uuid;copy(url)}

// è®¢é˜…è½¬æ¢æœåŠ¡
const apiBaseUrl='https://url.v1.mk/sub';

function toggleDropdown(event,uuid){
  event.stopPropagation();
  const allDropdowns=document.querySelectorAll('.dropdown-content');
  allDropdowns.forEach(d=>{if(d.id!=='dropdown-'+uuid)d.classList.remove('show')});
  const dropdown=document.getElementById('dropdown-'+uuid);
  dropdown.classList.toggle('show');
}

document.addEventListener('click',function(e){
  if(!e.target.matches('.btn-copy')){
    document.querySelectorAll('.dropdown-content').forEach(d=>d.classList.remove('show'));
  }
});

function copySubByType(uuid,type){
  const subUrlInput=document.getElementById('subUrl');
  const subUrl=subUrlInput?subUrlInput.value:'';
  const baseUrl=subUrl.includes('://')?subUrl:'https://'+(subUrl||window.location.host);
  const originalUrl=baseUrl+'/'+uuid;
  
  let finalUrl=originalUrl;
  if(type!=='original'){
    const targetMap={
      'clash':'clash','singbox':'singbox','surge':'surge',
      'shadowrocket':'shadowrocket','quanx':'quanx','v2ray':'v2ray','surfboard':'surfboard'
    };
    const target=targetMap[type]||type;
    finalUrl=apiBaseUrl+'?target='+target+'&url='+encodeURIComponent(originalUrl);
  }
  
  navigator.clipboard.writeText(finalUrl).then(()=>{
    const typeNames={
      'original':'åŸå§‹è®¢é˜…','clash':'Clash','singbox':'SingBox','surge':'Surge',
      'shadowrocket':'Shadowrocket','quanx':'Quantumult X','v2ray':'V2Ray','surfboard':'Surfboard'
    };
    toast('âœ… å·²å¤åˆ¶ '+(typeNames[type]||type)+' è®¢é˜…');
  });
  document.querySelectorAll('.dropdown-content').forEach(d=>d.classList.remove('show'));
}

function switchSection(section){
  document.querySelectorAll('.menu-item').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelector('[data-section="'+section+'"]').classList.add('active');
  document.getElementById('section-'+section).classList.add('active');
  // ä¿å­˜å½“å‰èœå•çŠ¶æ€
  localStorage.setItem('adminCurrentSection', section);
  if(section==='plans')loadPlans();
  if(section==='orders')loadOrders();
  if(section==='announcements')loadAnnouncements();
  if(section==='payment')loadPaymentChannels();
  if(section==='invites')loadInviteCodes();
  if(section==='proxy-ips')loadSettings();
  if(section==='best-domains')loadBestDomains();
  if(section==='logs')loadLogs();
  if(section==='stats')loadStats();
  if(section==='dashboard')loadDashboard();
}

// é¡µé¢åˆå§‹åŒ–
(function initPage(){
  const savedSection = localStorage.getItem('adminCurrentSection') || 'dashboard';
  // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå·²åŠ è½½
  setTimeout(()=>{
    switchSection(savedSection);
  }, 100);
  // å¯åŠ¨ä¼˜é€‰IPæ›´æ–°å€’è®¡æ—¶
  startBestIPCountdown();
})();

// è®¡ç®—ä¸‹æ¬¡cronæ‰§è¡Œæ—¶é—´çš„å€’è®¡æ—¶
function startBestIPCountdown(){
  function updateCountdown(){
    const now = new Date();
    const currentMinutes = now.getMinutes();
    const currentSeconds = now.getSeconds();
    
    // è®¡ç®—è·ç¦»ä¸‹ä¸€ä¸ª15åˆ†é’Ÿæ•´ç‚¹çš„å‰©ä½™æ—¶é—´
    const nextInterval = Math.ceil(currentMinutes / 15) * 15;
    let minutesLeft = nextInterval - currentMinutes;
    let secondsLeft = 60 - currentSeconds;
    
    if(secondsLeft === 60){
      secondsLeft = 0;
    } else {
      minutesLeft--;
    }
    
    // å¦‚æœæ˜¯æ•´ç‚¹ï¼Œæ˜¾ç¤ºä¸‹ä¸€ä¸ªå‘¨æœŸ
    if(minutesLeft < 0){
      minutesLeft = 14;
      secondsLeft = 60 - currentSeconds;
    }
    
    const countdownEl = document.getElementById('nextUpdateCountdown');
    if(countdownEl){
      if(minutesLeft === 0 && secondsLeft < 10){
        countdownEl.textContent = 'å³å°†æ›´æ–°...';
        countdownEl.style.color = '#52c41a';
      } else {
        countdownEl.textContent = minutesLeft + 'åˆ†' + secondsLeft + 'ç§’å';
        countdownEl.style.color = '#ff4d4f';
      }
    }
  }
  
  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  updateCountdown();
  // æ¯ç§’æ›´æ–°
  setInterval(updateCountdown, 1000);
}

async function loadDashboard(){try{const res1=await fetch('/api/admin/proxy-ips');const data1=await res1.json();const res2=await fetch('/api/admin/best-domains');const data2=await res2.json();const proxyCount=(data1.proxyIPs||[]).length;const domainCount=(data2.bestDomains||[]).length;const totalNodes=proxyCount+domainCount;const dashConfigEl=document.getElementById('dashConfigNodes');if(dashConfigEl)dashConfigEl.textContent=totalNodes;const settingsRes=await fetch('/api/admin/getSystemSettings');const settingsData=await settingsRes.json();if(settingsData.success){const s=settingsData.settings;const el1=document.getElementById('siteName');if(el1)el1.value=s.siteName||'CFly';const el2=document.getElementById('enableRegisterCheck');if(el2){el2.checked=s.enableRegister!==false;const slider=el2.parentElement.querySelector('.slider');if(slider)slider.style.background=el2.checked?'#52c41a':'#d9d9d9';}const el3=document.getElementById('autoApproveOrderCheck');if(el3){el3.checked=s.autoApproveOrder===true;const slider=el3.parentElement.querySelector('.slider');if(slider)slider.style.background=el3.checked?'#52c41a':'#d9d9d9';}const el4=document.getElementById('enableTrialCheck');if(el4){el4.checked=s.enableTrial===true;const slider=el4.parentElement.querySelector('.slider');if(slider)slider.style.background=el4.checked?'#52c41a':'#d9d9d9';}const el5=document.getElementById('trialDays');if(el5)el5.value=s.trialDays||7;const el6=document.getElementById('requireInviteCodeCheck');if(el6){el6.checked=s.requireInviteCode===true;const slider=el6.parentElement.querySelector('.slider');if(slider)slider.style.background=el6.checked?'#52c41a':'#d9d9d9';}const el7=document.getElementById('enableAutoCleanupCheck');if(el7){el7.checked=s.enableAutoCleanup===true;const slider=el7.parentElement.querySelector('.slider');if(slider)slider.style.background=el7.checked?'#52c41a':'#d9d9d9';}const el8=document.getElementById('autoCleanupDays');if(el8)el8.value=s.autoCleanupDays||7;const el9=document.getElementById('pendingOrderExpiry');if(el9)el9.value=s.pendingOrderExpiry||0;const el10=document.getElementById('paymentOrderExpiry');if(el10)el10.value=s.paymentOrderExpiry||15;const el11=document.getElementById('customLink1Name');if(el11)el11.value=s.customLink1Name||'';const el12=document.getElementById('customLink1Url');if(el12)el12.value=s.customLink1Url||'';const el13=document.getElementById('customLink2Name');if(el13)el13.value=s.customLink2Name||'';const el14=document.getElementById('customLink2Url');if(el14)el14.value=s.customLink2Url||'';const el15=document.getElementById('baseUrl');if(el15)el15.value=s.baseUrl||'';}}catch(e){console.error(e)}}
async function updateSystemSettings(){
  try{
    const data={
      siteName:(document.getElementById('siteName')||{}).value||'CFly',
      enableRegister:(document.getElementById('enableRegisterCheck')||{}).checked?'true':'false',
      autoApproveOrder:(document.getElementById('autoApproveOrderCheck')||{}).checked?'true':'false',
      enableTrial:(document.getElementById('enableTrialCheck')||{}).checked?'true':'false',
      trialDays:(document.getElementById('trialDays')||{}).value||'7',
      requireInviteCode:(document.getElementById('requireInviteCodeCheck')||{}).checked?'true':'false',
      pendingOrderExpiry:(document.getElementById('pendingOrderExpiry')||{}).value||'0',
      paymentOrderExpiry:(document.getElementById('paymentOrderExpiry')||{}).value||'15',
      customLink1Name:(document.getElementById('customLink1Name')||{}).value||'',
      customLink1Url:(document.getElementById('customLink1Url')||{}).value||'',
      customLink2Name:(document.getElementById('customLink2Name')||{}).value||'',
      customLink2Url:(document.getElementById('customLink2Url')||{}).value||'',
      enableAutoCleanup:(document.getElementById('enableAutoCleanupCheck')||{}).checked?'true':'false',
      autoCleanupDays:(document.getElementById('autoCleanupDays')||{}).value||'7',
      baseUrl:(document.getElementById('baseUrl')||{}).value||''
    };
    const res=await fetch('/api/admin/updateSystemSettings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    if(res.ok){showToast('âœ… è®¾ç½®å·²è‡ªåŠ¨ä¿å­˜','success');}
    else{showToast('ä¿å­˜å¤±è´¥','error');}
  }catch(e){console.error(e);showToast('ä¿å­˜å¤±è´¥','error');}
}

async function saveSystemSettings(){try{const data={siteName:document.getElementById('siteName').value,enableRegister:document.getElementById('enableRegister').checked?'true':'false',autoApproveOrder:document.getElementById('autoApproveOrder').checked?'true':'false',enableTrial:document.getElementById('enableTrial').checked?'true':'false',trialDays:document.getElementById('trialDays').value,requireInviteCode:document.getElementById('requireInviteCode').checked?'true':'false',pendingOrderExpiry:document.getElementById('pendingOrderExpiry').value,paymentOrderExpiry:document.getElementById('paymentOrderExpiry').value,customLink1Name:document.getElementById('customLink1Name').value,customLink1Url:document.getElementById('customLink1Url').value,customLink2Name:document.getElementById('customLink2Name').value,customLink2Url:document.getElementById('customLink2Url').value,enableAutoCleanup:document.getElementById('enableAutoCleanup').checked?'true':'false',autoCleanupDays:document.getElementById('autoCleanupDays').value};const res=await fetch('/api/admin/updateSystemSettings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('ç³»ç»Ÿè®¾ç½®ä¿å­˜æˆåŠŸ');loadDashboard()}else{alert('ä¿å­˜å¤±è´¥')}}catch(e){console.error(e);alert('ä¿å­˜å¤±è´¥')}}function toggleCheckAll(){const checked=document.getElementById('checkAll').checked;document.querySelectorAll('.u-check').forEach(c=>c.checked=checked);updateBatchBar()}function updateBatchBar(){const count=document.querySelectorAll('.u-check:checked').length;document.getElementById('selCount').textContent=count;const bar=document.getElementById('batchBar');bar.classList.toggle('show',count>0)}document.addEventListener('change',e=>{if(e.target.classList.contains('u-check'))updateBatchBar()});function getSelectedUUIDs(){return Array.from(document.querySelectorAll('.u-check:checked')).map(c=>c.value)}async function addUser(){const formData={name:document.getElementById('addName').value,expiryDate:document.getElementById('addExpiry').value,frontUsername:document.getElementById('addFrontUsername').value,frontPassword:document.getElementById('addFrontPassword').value,uuids:document.getElementById('addUUIDs').value};const res=await fetch('/api/admin/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(formData)});if(res.ok){toast('æ·»åŠ æˆåŠŸ');location.reload()}else toast('æ·»åŠ å¤±è´¥')}function openEdit(uuid,name,expiry){document.getElementById('editUUID').value=uuid;document.getElementById('editName').value=name;document.getElementById('editExpiry').value=expiry;document.getElementById('editFrontUsername').value='';document.getElementById('editFrontPassword').value='';fetch('/api/admin/user/'+uuid).then(r=>r.json()).then(data=>{if(data.frontAccount){document.getElementById('editFrontUsername').value=data.frontAccount.username||''}}).catch(e=>console.error(e));document.getElementById('editModal').style.display='flex'}async function resetUUID(uuid){if(!confirm('ç¡®å®šè¦é‡ç½®æ­¤ç”¨æˆ·çš„UUIDå—ï¼Ÿé‡ç½®ååŸè®¢é˜…é“¾æ¥å°†å¤±æ•ˆï¼Œç”¨æˆ·éœ€è¦é‡æ–°è·å–è®¢é˜…é“¾æ¥ï¼'))return;try{const res=await fetch('/api/admin/reset-uuid',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuid})});const data=await res.json();if(res.ok&&data.success){toast('UUIDå·²é‡ç½®ä¸º: '+data.newUUID);location.reload()}else{alert('é‡ç½®å¤±è´¥: '+(data.error||'æœªçŸ¥é”™è¯¯'))}}catch(e){alert('é‡ç½®å¤±è´¥: '+e.message)}}function closeEdit(){document.getElementById('editModal').style.display='none'}async function saveEdit(){const data={uuid:document.getElementById('editUUID').value,name:document.getElementById('editName').value,expiryDate:document.getElementById('editExpiry').value,frontUsername:document.getElementById('editFrontUsername').value,frontPassword:document.getElementById('editFrontPassword').value};const res=await fetch('/api/admin/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('ä¿å­˜æˆåŠŸ');location.reload()}else toast('ä¿å­˜å¤±è´¥')}async function toggleStatus(uuid,enabled){await fetch('/api/admin/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuids:uuid,enabled:enabled.toString()})});location.reload()}async function delUser(uuid){if(!confirm('ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·ï¼Ÿ'))return;await fetch('/api/admin/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuids:uuid})});location.reload()}async function batchEnable(){const uuids=getSelectedUUIDs();if(uuids.length===0)return toast('è¯·é€‰æ‹©ç”¨æˆ·');await fetch('/api/admin/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuids:uuids.join(','),enabled:'true'})});location.reload()}async function batchDisable(){const uuids=getSelectedUUIDs();if(uuids.length===0)return toast('è¯·é€‰æ‹©ç”¨æˆ·');await fetch('/api/admin/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuids:uuids.join(','),enabled:'false'})});location.reload()}async function batchDelete(){const uuids=getSelectedUUIDs();if(uuids.length===0)return toast('è¯·é€‰æ‹©ç”¨æˆ·');if(!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„ '+uuids.length+' ä¸ªç”¨æˆ·ï¼Ÿ'))return;await fetch('/api/admin/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uuids:uuids.join(',')})});location.reload()}async function loadPlans(){try{const res=await fetch('/api/admin/plans');const data=await res.json();const container=document.getElementById('plansList');if(!data.success||!data.plans||data.plans.length===0){container.innerHTML='<p style="text-align:center;color:#999">æš‚æ— å¥—é¤</p>';return}let html='<table><thead><tr><th>åç§°</th><th>æ—¶é•¿</th><th>ä»·æ ¼</th><th>æè¿°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';data.plans.forEach(p=>{const statusBadge=p.enabled?'<span class="tag active">ä¸Šæ¶</span>':'<span class="tag disabled">ä¸‹æ¶</span>';const toggleBtn=p.enabled?'<button onclick="togglePlan('+p.id+',false)" class="btn-action btn-warning">ä¸‹æ¶</button>':'<button onclick="togglePlan('+p.id+',true)" class="btn-action btn-success">ä¸Šæ¶</button>';const safeName=escapeHtml(p.name).replace(/'/g,"\\\\'").replace(/\\n/g,' ');const safeDesc=escapeHtml(p.description||'').replace(/'/g,"\\\\'").replace(/\\n/g,' ').replace(/\\r/g,'');const descPreview=(p.description||'-').replace(/<[^>]*>/g,'').substring(0,30);html+='<tr>';html+='<td>'+escapeHtml(p.name)+'</td>';html+='<td>'+p.duration_days+'å¤©</td>';html+='<td>Â¥'+(p.price||0)+'</td>';html+='<td>'+escapeHtml(descPreview)+(descPreview.length>=30?'...':'')+'</td>';html+='<td>'+statusBadge+'</td>';html+='<td>'+toggleBtn+' <button onclick="openPlanEditById('+p.id+')" class="btn-action btn-edit">ç¼–è¾‘</button> <button onclick="deletePlan('+p.id+')" class="btn-action btn-del">åˆ é™¤</button></td>';html+='</tr>'});html+='</tbody></table>';container.innerHTML=html}catch(e){console.error(e);document.getElementById('plansList').innerHTML='<p style="color:red">åŠ è½½å¤±è´¥</p>'}}async function addPlan(){const name=document.getElementById('planName').value.trim();const duration=document.getElementById('planDuration').value;const description=document.getElementById('planDescription').value.trim();const price=document.getElementById('planPrice').value||0;if(!name||!duration)return alert('è¯·å¡«å†™å¥—é¤åç§°å’Œæ—¶é•¿');const data={name,duration_days:duration,description,price};const res=await fetch('/api/admin/plans/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('å¥—é¤åˆ›å»ºæˆåŠŸ');document.getElementById('planName').value='';document.getElementById('planDuration').value='';document.getElementById('planDescription').value='';document.getElementById('planPrice').value='';loadPlans()}else alert('åˆ›å»ºå¤±è´¥')}async function togglePlan(id,enabled){const data={id,enabled:enabled?'true':'false'};const res=await fetch('/api/admin/plans/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('æ“ä½œæˆåŠŸ');loadPlans()}else alert('æ“ä½œå¤±è´¥')}async function deletePlan(id){if(!confirm('ç¡®å®šåˆ é™¤æ­¤å¥—é¤ï¼Ÿ'))return;const res=await fetch('/api/admin/plans/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});if(res.ok){toast('åˆ é™¤æˆåŠŸ');loadPlans()}else alert('åˆ é™¤å¤±è´¥')}

let currentPlanData={};

async function openPlanEditById(id){
  try{
    const res=await fetch('/api/admin/plans');
    const data=await res.json();
    if(data.success&&data.plans){
      const plan=data.plans.find(p=>p.id===id);
      if(plan){
        currentPlanData=plan;
        document.getElementById('editPlanId').value=plan.id;
        document.getElementById('editPlanName').value=plan.name||'';
        document.getElementById('editPlanDuration').value=plan.duration_days||30;
        document.getElementById('editPlanDescription').value=plan.description||'';
        document.getElementById('editPlanPrice').value=plan.price||0;
        document.getElementById('editPlanModal').style.display='flex';
      }
    }
  }catch(e){console.error(e);alert('è·å–å¥—é¤ä¿¡æ¯å¤±è´¥')}
}

function openPlanEdit(id,name,duration,description,price){document.getElementById('editPlanId').value=id;document.getElementById('editPlanName').value=name;document.getElementById('editPlanDuration').value=duration;document.getElementById('editPlanDescription').value=description;document.getElementById('editPlanPrice').value=price;document.getElementById('editPlanModal').style.display='flex'}function closePlanEdit(){document.getElementById('editPlanModal').style.display='none'}async function savePlanEdit(){const id=document.getElementById('editPlanId').value;const name=document.getElementById('editPlanName').value.trim();const duration=document.getElementById('editPlanDuration').value;const description=document.getElementById('editPlanDescription').value.trim();const price=document.getElementById('editPlanPrice').value||0;if(!name||!duration)return alert('è¯·å¡«å†™å¥—é¤åç§°å’Œæ—¶é•¿');const data={id,name,duration_days:duration,description,price};const res=await fetch('/api/admin/plans/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('æ›´æ–°æˆåŠŸ');closePlanEdit();loadPlans()}else alert('æ›´æ–°å¤±è´¥')}async function loadOrders(){try{const res=await fetch('/api/admin/orders');const data=await res.json();const container=document.getElementById('ordersList');const filterSelect=document.getElementById('orderStatusFilter');const statusFilter=filterSelect?filterSelect.value:'pending';let filteredOrders=data.orders||[];if(statusFilter!=='all'){filteredOrders=filteredOrders.filter(o=>o.status===statusFilter)}document.getElementById('orderBatchBar').style.display='none';if(filteredOrders.length===0){container.innerHTML='<p style="text-align:center;color:#999">æš‚æ— è®¢å•</p>';return}const hasPending=statusFilter==='pending'||(statusFilter==='all'&&filteredOrders.some(o=>o.status==='pending'));let html='<table><thead><tr>';if(hasPending)html+='<th width="40"><input type="checkbox" id="orderSelectAll" onclick="toggleOrderSelectAll()"></th>';html+='<th>ID</th><th>ç”¨æˆ·</th><th>å¥—é¤</th><th>é‡‘é¢</th><th>åˆ›å»ºæ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';filteredOrders.forEach(o=>{let statusBadge='',actions='',checkbox='';if(o.status==='pending'){statusBadge='<span class="tag" style="background:#faad14;color:white">å¾…å®¡æ ¸</span>';checkbox='<input type="checkbox" class="order-checkbox" value="'+o.id+'" onchange="updateOrderSelection()">';actions='<button onclick="approveOrder('+o.id+')" class="btn-action btn-success">é€šè¿‡</button> <button onclick="rejectOrder('+o.id+')" class="btn-action btn-del">æ‹’ç»</button>'}else if(o.status==='approved'){statusBadge='<span class="tag active">å·²é€šè¿‡</span>';actions='-'}else if(o.status==='rejected'){statusBadge='<span class="tag expired">å·²æ‹’ç»</span>';actions='-'}html+='<tr>';if(hasPending)html+='<td>'+checkbox+'</td>';html+='<td>#'+o.id+'</td>';html+='<td>'+(o.username||'-')+'</td>';html+='<td>'+(o.plan_name||'-')+' ('+o.duration_days+'å¤©)</td>';html+='<td>Â¥'+(o.amount||0)+'</td>';html+='<td>'+(o.created_at?new Date(o.created_at).toLocaleString('zh-CN'):'')+'</td>';html+='<td>'+statusBadge+'</td>';html+='<td>'+actions+'</td>';html+='</tr>'});html+='</tbody></table>';container.innerHTML=html}catch(e){console.error(e);document.getElementById('ordersList').innerHTML='<p style="color:red">åŠ è½½å¤±è´¥</p>'}}function toggleOrderSelectAll(){const selectAll=document.getElementById('orderSelectAll');const checkboxes=document.querySelectorAll('.order-checkbox');checkboxes.forEach(cb=>cb.checked=selectAll.checked);updateOrderSelection()}function updateOrderSelection(){const checkboxes=document.querySelectorAll('.order-checkbox:checked');const count=checkboxes.length;document.getElementById('orderSelCount').textContent=count;document.getElementById('orderBatchBar').style.display=count>0?'flex':'none'}async function batchOrderAction(action){const checkboxes=document.querySelectorAll('.order-checkbox:checked');if(checkboxes.length===0)return toast('è¯·å…ˆé€‰æ‹©è®¢å•');const actionText=action==='approve'?'é€šè¿‡':'æ‹’ç»';if(!confirm('ç¡®å®šè¦æ‰¹é‡'+actionText+' '+checkboxes.length+' ä¸ªè®¢å•å—ï¼Ÿ'))return;const orderIds=Array.from(checkboxes).map(cb=>cb.value);for(const orderId of orderIds){try{const endpoint=action==='approve'?'/api/admin/orders/approve':'/api/admin/orders/reject';await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({order_id:orderId})})}catch(e){}}toast('æ‰¹é‡æ“ä½œå®Œæˆ');loadOrders()}async function approveOrder(orderId){if(!confirm('ç¡®å®šé€šè¿‡æ­¤è®¢å•ï¼Ÿ'))return;const res=await fetch('/api/admin/orders/approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({order_id:orderId})});if(res.ok){toast('è®¢å•å·²é€šè¿‡');loadOrders()}else alert('æ“ä½œå¤±è´¥')}async function rejectOrder(orderId){if(!confirm('ç¡®å®šæ‹’ç»æ­¤è®¢å•ï¼Ÿ'))return;const res=await fetch('/api/admin/orders/reject',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({order_id:orderId})});if(res.ok){toast('è®¢å•å·²æ‹’ç»');loadOrders()}else alert('æ“ä½œå¤±è´¥')}async function saveSettings(){const data={subUrl:document.getElementById('subUrl').value};const res=await fetch('/api/admin/updateSystemSettings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok)toast('é…ç½®å·²ä¿å­˜');else toast('ä¿å­˜å¤±è´¥')}async function loadAnnouncements(){try{const res=await fetch('/api/admin/announcements');const data=await res.json();const container=document.getElementById('announcementsList');if(!data.success||!data.announcements||data.announcements.length===0){container.innerHTML='<p style="text-align:center;color:#999;padding:20px">æš‚æ— å…¬å‘Š</p>';return}let html='<table><thead><tr><th>æ ‡é¢˜</th><th>å†…å®¹</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';data.announcements.forEach(a=>{const statusBadge=a.enabled?'<span class="tag active">å¯ç”¨</span>':'<span class="tag disabled">ç¦ç”¨</span>';const contentPreview=(a.content||'').length>50?(a.content.substring(0,50)+'...'):a.content;html+='<tr>';html+='<td>'+a.title+'</td>';html+='<td>'+contentPreview+'</td>';html+='<td>'+statusBadge+'</td>';html+='<td>'+(a.created_at?new Date(a.created_at).toLocaleString('zh-CN'):'')+'</td>';html+='<td><button onclick="editAnnouncement('+a.id+')" class="btn-action btn-edit">ç¼–è¾‘</button> <button onclick="deleteAnnouncement('+a.id+')" class="btn-action btn-del">åˆ é™¤</button></td>';html+='</tr>'});html+='</tbody></table>';container.innerHTML=html}catch(e){console.error(e);document.getElementById('announcementsList').innerHTML='<p style="color:red">åŠ è½½å¤±è´¥</p>'}}function openAddAnnouncement(){document.getElementById('editAnnouncementId').value='';document.getElementById('editAnnouncementTitle').value='';document.getElementById('editAnnouncementContent').value='';document.getElementById('editAnnouncementEnabled').checked=true;document.getElementById('announcementModalTitle').textContent='æ·»åŠ å…¬å‘Š';document.getElementById('editAnnouncementModal').style.display='flex'}async function editAnnouncement(id){try{const res=await fetch('/api/admin/announcements/'+id);const data=await res.json();if(data.success){document.getElementById('editAnnouncementId').value=data.announcement.id;document.getElementById('editAnnouncementTitle').value=data.announcement.title;document.getElementById('editAnnouncementContent').value=data.announcement.content||'';document.getElementById('editAnnouncementEnabled').checked=data.announcement.enabled;document.getElementById('announcementModalTitle').textContent='ç¼–è¾‘å…¬å‘Š';document.getElementById('editAnnouncementModal').style.display='flex'}}catch(e){alert('è·å–å…¬å‘Šä¿¡æ¯å¤±è´¥')}}function closeAnnouncementEdit(){document.getElementById('editAnnouncementModal').style.display='none'}async function saveAnnouncementEdit(){const id=document.getElementById('editAnnouncementId').value;const title=document.getElementById('editAnnouncementTitle').value.trim();const content=document.getElementById('editAnnouncementContent').value.trim();const enabled=document.getElementById('editAnnouncementEnabled').checked;if(!title||!content)return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');const data={title,content,enabled:enabled?1:0};const endpoint=id?'/api/admin/announcements/update':'/api/admin/announcements/create';const body=id?{id,...data}:data;const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(res.ok){toast(id?'æ›´æ–°æˆåŠŸ':'åˆ›å»ºæˆåŠŸ');closeAnnouncementEdit();loadAnnouncements()}else alert('æ“ä½œå¤±è´¥')}async function deleteAnnouncement(id){if(!confirm('ç¡®å®šåˆ é™¤æ­¤å…¬å‘Šï¼Ÿ'))return;const res=await fetch('/api/admin/announcements/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});if(res.ok){toast('åˆ é™¤æˆåŠŸ');loadAnnouncements()}else alert('åˆ é™¤å¤±è´¥')}async function loadPaymentChannels(){try{const res=await fetch('/api/admin/payment/channels');const data=await res.json();const container=document.getElementById('paymentChannelsList');if(!data.success||!data.channels||data.channels.length===0){container.innerHTML='<p style="text-align:center;color:#999;padding:20px">æš‚æ— æ”¯ä»˜é€šé“ï¼Œè¯·æ·»åŠ </p>';return}let html='<table style="width:100%"><thead><tr><th>ID</th><th>åç§°</th><th>ä»£ç </th><th>API åœ°å€</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';data.channels.forEach(c=>{const statusBadge=c.enabled?'<span class="badge" style="background:#52c41a;color:white;padding:4px 8px;border-radius:4px">å¯ç”¨</span>':'<span class="badge" style="background:#999;color:white;padding:4px 8px;border-radius:4px">ç¦ç”¨</span>';const toggleBtn=c.enabled?'<button onclick="togglePaymentChannel('+c.id+',false)" class="btn-action" style="background:#ff9500">ç¦ç”¨</button>':'<button onclick="togglePaymentChannel('+c.id+',true)" class="btn-action btn-success">å¯ç”¨</button>';html+='<tr>';html+='<td>'+c.id+'</td>';html+='<td>'+(c.name||'')+'</td>';html+='<td><code>'+(c.code||'')+'</code></td>';html+='<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">'+(c.api_url||'')+'</td>';html+='<td>'+statusBadge+'</td>';html+='<td>'+toggleBtn+' <button onclick="editPaymentChannel('+c.id+')" class="btn-action btn-edit">ç¼–è¾‘</button> <button onclick="deletePaymentChannel('+c.id+')" class="btn-action btn-del">åˆ é™¤</button></td>';html+='</tr>'});html+='</tbody></table>';container.innerHTML=html}catch(e){console.error(e);document.getElementById('paymentChannelsList').innerHTML='<p style="color:red">åŠ è½½å¤±è´¥</p>'}}async function addPaymentChannel(){const name=document.getElementById('paymentName').value.trim();const type=document.getElementById('paymentType').value;const config=document.getElementById('paymentConfig').value.trim();if(!name||!config)return alert('è¯·å¡«å†™æ¸ é“åç§°å’Œé…ç½®');const data={name,type,config};const res=await fetch('/api/admin/payment-channels/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('æ·»åŠ æˆåŠŸ');document.getElementById('paymentName').value='';document.getElementById('paymentConfig').value='';loadPaymentChannels()}else alert('æ·»åŠ å¤±è´¥')}async function togglePaymentChannel(id,enabled){const res=await fetch('/api/admin/payment/channels/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,enabled:enabled?'true':'false'})});if(res.ok){toast('æ“ä½œæˆåŠŸ');loadPaymentChannels()}else alert('æ“ä½œå¤±è´¥')}async function deletePaymentChannel(id){if(!confirm('ç¡®å®šåˆ é™¤æ­¤æ”¯ä»˜æ¸ é“ï¼Ÿ'))return;const res=await fetch('/api/admin/payment/channels/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});if(res.ok){toast('åˆ é™¤æˆåŠŸ');loadPaymentChannels()}else alert('åˆ é™¤å¤±è´¥')}async function editPaymentChannel(id){try{const res=await fetch('/api/admin/payment/channels');const data=await res.json();if(data.success){const channel=data.channels.find(c=>c.id===id);if(channel){document.getElementById('editPayChannelId').value=channel.id;document.getElementById('editPayChannelName').value=channel.name||'';document.getElementById('editPayChannelCode').value=channel.code||'';document.getElementById('editPayChannelApiUrl').value=channel.api_url||'';document.getElementById('editPayChannelApiToken').value=channel.api_token||'';document.getElementById('editPaymentChannelModal').style.display='flex'}}}catch(e){alert('è·å–æ”¯ä»˜é€šé“ä¿¡æ¯å¤±è´¥')}}function closePaymentChannelEdit(){document.getElementById('editPaymentChannelModal').style.display='none'}async function savePaymentChannelEdit(){const id=document.getElementById('editPayChannelId').value;const name=document.getElementById('editPayChannelName').value.trim();const code=document.getElementById('editPayChannelCode').value.trim();const apiUrl=document.getElementById('editPayChannelApiUrl').value.trim();const apiToken=document.getElementById('editPayChannelApiToken').value.trim();if(!name||!code||!apiUrl)return alert('è¯·å¡«å†™é€šé“åç§°ã€ä»£ç å’ŒAPIåœ°å€');const data={id,name,code,api_url:apiUrl,api_token:apiToken};const res=await fetch('/api/admin/payment/channels/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('æ›´æ–°æˆåŠŸ');closePaymentChannelEdit();loadPaymentChannels()}else alert('æ›´æ–°å¤±è´¥')}async function savePaymentChannel(){const name=document.getElementById('payChannelName').value.trim();const code=document.getElementById('payChannelCode').value.trim();const apiUrl=document.getElementById('payChannelApiUrl').value.trim();const apiToken=document.getElementById('payChannelApiToken').value.trim();if(!name||!code||!apiUrl)return alert('è¯·å¡«å†™é€šé“åç§°ã€ä»£ç å’ŒAPIåœ°å€');const data={name,code,api_url:apiUrl,api_token:apiToken};const res=await fetch('/api/admin/payment/channels/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('æ·»åŠ æˆåŠŸ');document.getElementById('payChannelName').value='';document.getElementById('payChannelCode').value='';document.getElementById('payChannelApiUrl').value='';document.getElementById('payChannelApiToken').value='';loadPaymentChannels()}else alert('æ·»åŠ å¤±è´¥')}async function loadInviteCodes(){try{const res=await fetch('/api/admin/invites');const data=await res.json();const container=document.getElementById('inviteCodesList');if(!data.success||!data.invites||data.invites.length===0){container.innerHTML='<p style="text-align:center;color:#999;padding:40px 0">æš‚æ— é‚€è¯·ç </p>';return}let html='<div style="overflow-x:auto"><table style="width:100%;min-width:700px"><thead><tr><th>é‚€è¯·ç </th><th>å¯ç”¨/æ€»æ•°</th><th>èµ é€å¤©æ•°</th><th>å¤‡æ³¨</th><th>åˆ›å»ºæ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';data.invites.forEach(inv=>{const createdDate=inv.created_at?new Date(inv.created_at).toLocaleString('zh-CN'):'';const remaining=inv.max_uses-inv.used_count;const isActive=inv.enabled&&remaining>0;const statusColor=isActive?'#52c41a':'#d9d9d9';const statusText=!inv.enabled?'å·²ç¦ç”¨':(remaining<=0?'å·²ç”¨å®Œ':'å¯ç”¨');html+='<tr>';html+='<td style="font-family:monospace;font-weight:600;cursor:pointer" onclick="copy(\\''+inv.code+'\\')">'+inv.code+' ğŸ“‹</td>';html+='<td>'+remaining+' / '+inv.max_uses+'</td>';html+='<td>'+(inv.trial_days>0?inv.trial_days+'å¤©':'-')+'</td>';html+='<td style="color:#666">'+(inv.remark||'-')+'</td>';html+='<td style="color:#999;font-size:13px">'+createdDate+'</td>';html+='<td><span style="display:inline-block;padding:4px 12px;background:'+statusColor+';color:white;border-radius:12px;font-size:12px">'+statusText+'</span></td>';html+='<td>';if(inv.enabled){html+='<button onclick="toggleInviteCode('+inv.id+',false)" class="btn-action btn-secondary" style="margin-right:5px">ç¦ç”¨</button>'}else{html+='<button onclick="toggleInviteCode('+inv.id+',true)" class="btn-action btn-success" style="margin-right:5px">å¯ç”¨</button>'}html+='<button onclick="editInviteCode('+inv.id+',\\''+inv.code+'\\','+inv.max_uses+','+inv.trial_days+',\\''+(inv.remark||'')+'\\','+inv.used_count+')" class="btn-action btn-edit" style="margin-right:5px">ç¼–è¾‘</button>';html+='<button onclick="deleteInviteCode('+inv.id+')" class="btn-action btn-del">åˆ é™¤</button>';html+='</td>';html+='</tr>'});html+='</tbody></table></div>';container.innerHTML=html}catch(e){console.error(e);document.getElementById('inviteCodesList').innerHTML='<p style="color:red">åŠ è½½å¤±è´¥</p>'}}async function createInviteCode(){const code=document.getElementById('inviteCode').value.trim();const maxUses=document.getElementById('inviteMaxUses').value||1;const trialDays=document.getElementById('inviteTrialDays').value||0;const remark=document.getElementById('inviteRemark').value.trim();const data={max_uses:maxUses,trial_days:trialDays,remark};if(code)data.code=code;const res=await fetch('/api/admin/invites/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});const result=await res.json();if(res.ok&&result.success){toast('âœ… é‚€è¯·ç å·²ç”Ÿæˆ: '+result.code);document.getElementById('inviteCode').value='';document.getElementById('inviteMaxUses').value='1';document.getElementById('inviteTrialDays').value='0';document.getElementById('inviteRemark').value='';loadInviteCodes()}else alert('ç”Ÿæˆå¤±è´¥: '+(result.error||'æœªçŸ¥é”™è¯¯'))}async function toggleInviteCode(id,enabled){const res=await fetch('/api/admin/invites/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,enabled:enabled?'true':'false'})});if(res.ok){toast('æ“ä½œæˆåŠŸ');loadInviteCodes()}else alert('æ“ä½œå¤±è´¥')}async function deleteInviteCode(id){if(!confirm('ç¡®å®šåˆ é™¤æ­¤é‚€è¯·ç ï¼Ÿ'))return;const res=await fetch('/api/admin/invites/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});if(res.ok){toast('åˆ é™¤æˆåŠŸ');loadInviteCodes()}else alert('åˆ é™¤å¤±è´¥')}function editInviteCode(id,code,maxUses,trialDays,remark,usedCount){document.getElementById('editInviteId').value=id;document.getElementById('editInviteCode').value=code;document.getElementById('editInviteMaxUses').value=maxUses;document.getElementById('editInviteUsedCount').value=usedCount;document.getElementById('editInviteTrialDays').value=trialDays;document.getElementById('editInviteRemark').value=remark;document.getElementById('editInviteCodeModal').style.display='flex'}function closeInviteEdit(){document.getElementById('editInviteCodeModal').style.display='none'}async function saveInviteEdit(){const id=document.getElementById('editInviteId').value;const code=document.getElementById('editInviteCode').value.trim();const maxUses=document.getElementById('editInviteMaxUses').value;const trialDays=document.getElementById('editInviteTrialDays').value;const remark=document.getElementById('editInviteRemark').value.trim();if(!code||!maxUses)return alert('è¯·å¡«å†™é‚€è¯·ç å’Œæœ€å¤§ä½¿ç”¨æ¬¡æ•°');const data={id,code,max_uses:maxUses,trial_days:trialDays,remark};const res=await fetch('/api/admin/invites/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok){toast('æ›´æ–°æˆåŠŸ');closeInviteEdit();loadInviteCodes()}else alert('æ›´æ–°å¤±è´¥')}let bestDomainsData=[];

let proxyIPsData=[];

// åŠ è½½å¹¶æ˜¾ç¤ºåä»£IPåˆ—è¡¨ï¼ˆä»å·²ä¿å­˜çš„æ•°æ®æ¸²æŸ“ï¼Œä¸ä»textareaè¯»å–ï¼‰
function loadAndRenderProxyIPs(){
  // å¦‚æœ proxyIPsData ä¸ºç©ºï¼Œä¸åšä»»ä½•æ“ä½œï¼ˆç­‰å¾… loadSettings å¡«å……æ•°æ®ï¼‰
  renderProxyIPList();
}

// æ·»åŠ åä»£IPåˆ°åˆ—è¡¨
function addProxyIPs(){
  const input=document.getElementById('proxyIPInput').value.trim();
  if(!input)return;
  const lines=input.split('\\n').map(l=>l.trim()).filter(l=>l);
  let count=0;
  lines.forEach(line=>{
    let val=line;
    if(!val.includes(':'))val+=':443';
    if(!proxyIPsData.includes(val)){
      proxyIPsData.push(val);
      count++;
    }
  });
  document.getElementById('proxyIPInput').value='';
  renderProxyIPList();
  if(count>0)toast('å·²æ·»åŠ  '+count+' æ¡');
}

// æ¸…ç©ºåä»£IPåˆ—è¡¨
function clearProxyIPs(){
  if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰åä»£IPï¼Ÿ'))return;
  proxyIPsData=[];
  renderProxyIPList();
  toast('å·²æ¸…ç©º');
}

function renderProxyIPList(){
  const container=document.getElementById('proxyIPList');
  if(proxyIPsData.length===0){
    container.innerHTML='<div style="padding:20px;text-align:center;color:#999">æš‚æ— åä»£IP</div>';
    return;
  }
  container.innerHTML='';
  proxyIPsData.forEach((ip,idx)=>{
    const div=document.createElement('div');
    div.className='config-item';
    div.draggable=true;
    div.dataset.index=idx;
    div.dataset.type='ProxyIP';
    div.innerHTML='<span class="drag-handle">â˜°</span><span style="flex:1;font-family:monospace;font-size:13px">'+ip+'</span><span class="del-btn" onclick="delProxyIP('+idx+')">Ã—</span>';
    
    div.addEventListener('dragstart',(e)=>{
      e.dataTransfer.effectAllowed='move';
      e.dataTransfer.setData('text/plain',idx);
      div.classList.add('dragging');
    });
    
    div.addEventListener('dragend',()=>{
      div.classList.remove('dragging');
    });
    
    div.addEventListener('dragover',(e)=>{
      e.preventDefault();
      const draggingEl=container.querySelector('.dragging');
      if(!draggingEl||draggingEl===div)return;
      const rect=div.getBoundingClientRect();
      const offset=e.clientY-rect.top-rect.height/2;
      if(offset>0){div.after(draggingEl);}else{div.before(draggingEl);}
    });
    
    div.addEventListener('drop',(e)=>{
      e.preventDefault();
      const fromIndex=parseInt(e.dataTransfer.getData('text/plain'));
      const items=container.querySelectorAll('.config-item');
      const newOrder=[];
      items.forEach(item=>newOrder.push(proxyIPsData[parseInt(item.dataset.index)]));
      proxyIPsData=newOrder;
      renderProxyIPList();
      toast('âœ… é¡ºåºå·²è°ƒæ•´');
    });
    
    container.appendChild(div);
  });
}

function delProxyIP(idx){
  proxyIPsData.splice(idx,1);
  renderProxyIPList();
}

// é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåä»£IPåˆ—è¡¨
if(document.getElementById('proxyIPInput')){
  loadAndRenderProxyIPs();
}

async function loadProxyIPs(){
  // åä»£IPç°åœ¨ç›´æ¥ä»textareaåŠ è½½ï¼Œä¸éœ€è¦é¢å¤–æ“ä½œ
}

async function saveProxySettings(){
  try{
    // ä½¿ç”¨ proxyIPsData æ•°ç»„è€Œä¸æ˜¯ä» textarea è¯»å–
    const proxyIPLines = proxyIPsData.map(line=>{
      return line.includes(':') ? line : line+':443';
    });
    
    const subUrl = document.getElementById('subUrl').value.trim();
    const websiteUrl = document.getElementById('websiteUrl').value.trim();
    
    // å…ˆè·å–å½“å‰è®¾ç½®
    const settingsRes = await fetch('/api/admin/getSystemSettings');
    const settingsData = await settingsRes.json();
    const currentSettings = settingsData.settings || {};
    
    const data = {
      proxyIP: proxyIPLines.join('\\n'),
      bestDomains: (currentSettings.bestDomains && currentSettings.bestDomains.length > 0) ? currentSettings.bestDomains.join('\\n') : '', // ä¿æŒç°æœ‰çš„bestDomains
      subUrl: subUrl,
      websiteUrl: websiteUrl
    };
    
    const res = await fetch('/api/admin/saveSettings',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    
    if(res.ok){
      toast('âœ… ä¿å­˜æˆåŠŸ');
    } else {
      toast('âŒ ä¿å­˜å¤±è´¥');
    }
  } catch(e){
    console.error(e);
    toast('âŒ ä¿å­˜å¤±è´¥');
  }
}async function loadBestDomains(){try{const res=await fetch('/api/admin/best-domains');const data=await res.json();if(data.success){bestDomainsData=data.bestDomains||[];renderBestDomainList()}}catch(e){console.error(e);toast('åŠ è½½å¤±è´¥')}}function renderBestDomainList(){const container=document.getElementById('bestDomainList');if(bestDomainsData.length===0){container.innerHTML='<div style="padding:20px;text-align:center;color:#999">æš‚æ— ä¼˜é€‰åŸŸå</div>';return}container.innerHTML='';bestDomainsData.forEach((domain,idx)=>{const div=document.createElement('div');div.className='config-item';div.draggable=true;div.dataset.index=idx;div.dataset.type='BestDomain';div.innerHTML='<span class="drag-handle">â˜°</span><span style="flex:1;font-family:monospace;font-size:13px">'+domain+'</span><span class="del-btn" onclick="removeBestDomain('+idx+')">Ã—</span>';div.addEventListener('dragstart',(e)=>{e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',idx);div.classList.add('dragging')});div.addEventListener('dragend',()=>{div.classList.remove('dragging')});div.addEventListener('dragover',(e)=>{e.preventDefault();const draggingEl=container.querySelector('.dragging');if(!draggingEl||draggingEl===div)return;const rect=div.getBoundingClientRect();const offset=e.clientY-rect.top-rect.height/2;if(offset>0){div.after(draggingEl)}else{div.before(draggingEl)}});div.addEventListener('drop',(e)=>{e.preventDefault();const items=container.querySelectorAll('.config-item');const newOrder=[];items.forEach(item=>newOrder.push(bestDomainsData[parseInt(item.dataset.index)]));bestDomainsData=newOrder;renderBestDomainList();toast('âœ… é¡ºåºå·²è°ƒæ•´')});container.appendChild(div)})}function addBestDomains(){const input=document.getElementById('bestDomainInput').value.trim();if(!input)return;const lines=input.split('\\n').map(l=>l.trim()).filter(l=>l);bestDomainsData.push(...lines);document.getElementById('bestDomainInput').value='';renderBestDomainList();toast('å·²æ·»åŠ  '+lines.length+' ä¸ªåŸŸå')}function removeBestDomain(idx){bestDomainsData.splice(idx,1);renderBestDomainList()}function clearBestDomains(){if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰ä¼˜é€‰åŸŸåï¼Ÿ'))return;bestDomainsData=[];renderBestDomainList();toast('å·²æ¸…ç©º')}

async function fetchBestIPs(type){
  const btn=event.target;
  const originalText=btn.innerText;
  btn.innerText='è·å–ä¸­...';
  btn.disabled=true;
  try{
    const res=await fetch('/api/admin/fetchBestIPs',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:type})});
    if(!res.ok){toast('âŒ è·å–å¤±è´¥');return}
    const result=await res.json();
    if(!result.success){toast('âŒ '+(result.error||'è·å–å¤±è´¥'));return}
    const ipVersion=type==='v6'?'IPv6':'IPv4';
    const versionTag=type==='v6'?'v6':'v4';
    await loadBestDomains();
    const manualDomains=[];
    const allAutoDomains={};
    bestDomainsData.forEach(domain=>{
      const autoMatch=domain.match(/^(\[?[0-9a-fA-F:.]+\]?):443#(v4|v6)(ç§»åŠ¨|è”é€š|ç”µä¿¡|é“é€š|å¹¿ç”µ)\s+[A-Z]{3}$/);
      if(!autoMatch){
        manualDomains.push(domain);
      }else{
        const[,ip,ver,line]=autoMatch;
        const lineKey=line+'_'+ver;
        if(!allAutoDomains[lineKey])allAutoDomains[lineKey]=[];
        allAutoDomains[lineKey].push(domain);
      }
    });
    const newDataByLine={};
    result.data.forEach(item=>{
      const lineKey=item.lineKey;
      if(!newDataByLine[lineKey])newDataByLine[lineKey]=[];
      if(newDataByLine[lineKey].length<5){
        newDataByLine[lineKey].push(item.entry);
      }
    });
    const newAutoDomains=[];
    const allLineKeys=new Set([...Object.keys(newDataByLine),...Object.keys(allAutoDomains)]);
    allLineKeys.forEach(lineKey=>{
      const newIPs=newDataByLine[lineKey]||[];
      const oldIPs=allAutoDomains[lineKey]||[];
      if(newIPs.length>0){
        const merged=[...newIPs.slice(0,5)];
        if(merged.length<5){
          for(const oldIP of oldIPs){
            if(!merged.includes(oldIP)){
              merged.push(oldIP);
              if(merged.length>=5)break;
            }
          }
        }
        newAutoDomains.push(...merged.slice(0,5));
      }else{
        newAutoDomains.push(...oldIPs.slice(0,5));
      }
    });
    bestDomainsData=[...manualDomains,...newAutoDomains];
    renderBestDomainList();
    const saveRes=await fetch('/api/admin/best-domains',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bestDomains:bestDomainsData})});
    if(saveRes.ok){toast('âœ… æˆåŠŸè·å– '+result.count+' æ¡'+ipVersion+'ä¼˜é€‰IPï¼Œå·²æ›¿æ¢')}
    else{toast('âš ï¸ è·å–æˆåŠŸä½†ä¿å­˜å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¿å­˜')}
  }catch(e){console.error(e);toast('âŒ è·å–å¤±è´¥:'+e.message)}
  finally{btn.innerText=originalText;btn.disabled=false}
}

async function saveBestDomainSettings(){try{const res=await fetch('/api/admin/best-domains',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bestDomains:bestDomainsData})});if(res.ok){toast('ä¿å­˜æˆåŠŸ')}else{toast('ä¿å­˜å¤±è´¥')}}catch(e){console.error(e);toast('ä¿å­˜å¤±è´¥')}}async function saveSettings(){const data={subUrl:document.getElementById('subUrl').value,pendingOrderExpiry:parseInt(document.getElementById('pendingOrderExpiry').value)||24,paymentOrderExpiry:parseInt(document.getElementById('paymentOrderExpiry').value)||1,customLink1Url:document.getElementById('customLink1').value,customLink2Url:document.getElementById('customLink2').value,requireInviteCode:document.getElementById('requireInviteCode').checked?'true':'false',autoCleanupDays:parseInt(document.getElementById('autoCleanupDays').value)||0};const res=await fetch('/api/admin/updateSystemSettings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(res.ok)toast('é…ç½®å·²ä¿å­˜');else toast('ä¿å­˜å¤±è´¥')}async function adminLogout(){await fetch('/api/admin/logout',{method:'POST'});location.reload()}async function changePassword(){const oldPassword=document.getElementById('oldPassword').value.trim();const newPassword=document.getElementById('newPassword').value.trim();const confirmPassword=document.getElementById('confirmPassword').value.trim();if(!oldPassword||!newPassword||!confirmPassword)return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');if(newPassword.length<6)return alert('æ–°å¯†ç è‡³å°‘6ä½');if(newPassword!==confirmPassword)return alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');const res=await fetch('/api/admin/change-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({oldPassword,newPassword})});const data=await res.json();if(res.ok){toast('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');document.getElementById('oldPassword').value='';document.getElementById('newPassword').value='';document.getElementById('confirmPassword').value='';setTimeout(()=>adminLogout(),2000)}else{alert(data.error||'ä¿®æ”¹å¤±è´¥')}}async function exportData(){try{const res=await fetch('/api/admin/export-all');const data=await res.json();const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='vles-data-'+Date.now()+'.json';a.click();toast('æ•°æ®å¯¼å‡ºæˆåŠŸ')}catch(e){alert('å¯¼å‡ºå¤±è´¥:'+e.message)}}async function exportAllData(){return exportData()}async function importData(){const fileInput=document.getElementById('importFile');if(!fileInput||!fileInput.files[0]){alert('è¯·å…ˆé€‰æ‹©å¤‡ä»½æ–‡ä»¶');return}const file=fileInput.files[0];const reader=new FileReader();reader.onload=async function(e){try{const jsonData=JSON.parse(e.target.result);if(!confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†è¦†ç›–ç°æœ‰æ•°æ®ï¼'))return;const res=await fetch('/api/admin/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(jsonData)});const result=await res.json();if(result.success){let msg='å¯¼å…¥å®Œæˆï¼\\n';if(result.counts){msg+='ç”¨æˆ·: '+result.counts.users+'\\n';msg+='è´¦å·: '+result.counts.userAccounts+'\\n';msg+='è®¾ç½®: '+result.counts.settings+'\\n';msg+='å¥—é¤: '+result.counts.plans+'\\n';msg+='è®¢å•: '+result.counts.orders+'\\n';msg+='å…¬å‘Š: '+result.counts.announcements+'\\n';msg+='é‚€è¯·ç : '+result.counts.inviteCodes}alert(msg);location.reload()}else{alert('å¯¼å…¥å¤±è´¥: '+(result.error||'æœªçŸ¥é”™è¯¯'))}}catch(err){alert('æ–‡ä»¶è§£æå¤±è´¥: '+err.message)}};reader.readAsText(file)}async function importAllDataFile(input){if(!input.files||!input.files[0])return;const file=input.files[0];const reader=new FileReader();reader.onload=async function(e){try{const jsonData=JSON.parse(e.target.result);if(!confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†è¦†ç›–ç°æœ‰æ•°æ®ï¼'))return;const res=await fetch('/api/admin/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(jsonData)});const result=await res.json();if(result.success){let msg='å¯¼å…¥å®Œæˆï¼\\n';if(result.counts){msg+='ç”¨æˆ·: '+result.counts.users+'\\n';msg+='è´¦å·: '+result.counts.userAccounts+'\\n';msg+='è®¾ç½®: '+result.counts.settings+'\\n';msg+='å¥—é¤: '+result.counts.plans+'\\n';msg+='è®¢å•: '+result.counts.orders+'\\n';msg+='å…¬å‘Š: '+result.counts.announcements+'\\n';msg+='é‚€è¯·ç : '+result.counts.inviteCodes}alert(msg);location.reload()}else{alert('å¯¼å…¥å¤±è´¥: '+(result.error||'æœªçŸ¥é”™è¯¯'))}}catch(err){alert('æ–‡ä»¶è§£æå¤±è´¥: '+err.message)}};reader.readAsText(file);input.value=''}async function loadLogs(){try{const res=await fetch('/api/admin/logs?limit=100');const data=await res.json();const container=document.getElementById('logsList');if(!data.logs||data.logs.length===0){container.innerHTML='<div style="padding:20px;text-align:center;color:#999">æš‚æ— æ—¥å¿—</div>';return}let html='';data.logs.forEach(log=>{const levelColors={'info':'#1890ff','success':'#52c41a','warning':'#faad14','error':'#ff4d4f'};const levelColor=levelColors[log.level]||'#666';const time=new Date(log.timestamp).toLocaleString('zh-CN');html+='<div style="border-bottom:1px solid #eee;padding:8px;display:flex;gap:15px;font-size:13px;align-items:flex-start">';html+='<div style="min-width:150px;color:#999">'+time+'</div>';html+='<div style="min-width:60px;color:'+levelColor+';font-weight:600">['+log.level.toUpperCase()+']</div>';html+='<div style="flex:1;color:#333"><b>'+log.action+'</b>';if(log.details)html+='<br><span style="color:#666;font-size:12px">'+log.details+'</span>';html+='</div></div>'});container.innerHTML=html}catch(e){document.getElementById('logsList').innerHTML='<div style="color:red">åŠ è½½å¤±è´¥</div>'}}async function clearLogs(){if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ—¥å¿—ï¼Ÿ'))return;const res=await fetch('/api/admin/logs/clear',{method:'POST'});if(res.ok){toast('æ—¥å¿—å·²æ¸…ç©º');loadLogs()}else{alert('æ“ä½œå¤±è´¥')}}async function loadStats(){try{const res=await fetch('/api/admin/statistics');const stats=await res.json();const overview=document.getElementById('statsOverview');let html='';html+='<div style="padding:20px;background:#e6f7ff;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:bold;color:var(--primary)">'+stats.users.total+'</div><div style="margin-top:8px;color:#666">æ€»ç”¨æˆ·æ•°</div></div>';html+='<div style="padding:20px;background:#f6ffed;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:bold;color:var(--success)">'+stats.users.active+'</div><div style="margin-top:8px;color:#666">æ´»è·ƒç”¨æˆ·</div></div>';html+='<div style="padding:20px;background:#fff7e6;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:bold;color:var(--warning)">'+stats.orders.pending+'</div><div style="margin-top:8px;color:#666">å¾…å®¡æ ¸è®¢å•</div></div>';html+='<div style="padding:20px;background:#fff1f0;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:bold;color:var(--danger)">Â¥'+stats.orders.totalRevenue+'</div><div style="margin-top:8px;color:#666">æ€»æ”¶å…¥</div></div>';overview.innerHTML=html;const userTrend=document.getElementById('userTrend');let trendHtml='<div style="display:flex;flex-direction:column;gap:10px">';stats.users.last7Days.forEach(d=>{const barWidth=d.count*20||5;trendHtml+='<div style="display:flex;align-items:center;gap:15px">';trendHtml+='<div style="min-width:100px;color:#666;font-size:14px">'+d.date+'</div>';trendHtml+='<div style="background:linear-gradient(90deg,var(--primary),#69c0ff);height:25px;width:'+barWidth+'px;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding:0 10px;color:white;font-size:12px;font-weight:600">'+d.count+'</div>';trendHtml+='</div>'});trendHtml+='</div>';userTrend.innerHTML=trendHtml;const orderTrend=document.getElementById('orderTrend');let orderHtml='<div style="display:flex;flex-direction:column;gap:10px">';stats.orders.last7Days.forEach(d=>{const barWidth=d.count*20||5;const revenueWidth=d.revenue*2||5;orderHtml+='<div style="margin-bottom:15px">';orderHtml+='<div style="display:flex;align-items:center;gap:15px;margin-bottom:5px">';orderHtml+='<div style="min-width:100px;color:#666;font-size:14px">'+d.date+'</div>';orderHtml+='<div style="background:linear-gradient(90deg,var(--success),#95de64);height:20px;width:'+barWidth+'px;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding:0 8px;color:white;font-size:11px;font-weight:600">'+d.count+'å•</div>';orderHtml+='</div>';orderHtml+='<div style="display:flex;align-items:center;gap:15px">';orderHtml+='<div style="min-width:100px"></div>';orderHtml+='<div style="background:linear-gradient(90deg,var(--warning),#ffd666);height:20px;width:'+revenueWidth+'px;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding:0 8px;color:white;font-size:11px;font-weight:600">Â¥'+d.revenue+'</div>';orderHtml+='</div>';orderHtml+='</div>'});orderHtml+='</div>';orderTrend.innerHTML=orderHtml}catch(e){console.error(e);toast('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥')}}</script></body></html>`;
}

module.exports = {
    renderAdminPanel,
    renderAdminLoginPage
};
